---
title: "RSA simple"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import data and libraries

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(cowplot)
# library(plyr)
library(tidyverse)
library(here)
# library(boot)

theme_set(theme_cowplot())

target_color = "#d55e00" # red
comp_color = "#009e74"

model_color = "#cc79a7" # purple
emp_color = "#0071b2" # blue
  
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

# imports comprehension data (already only critical trials)
df_comprehension_import = read_csv(here("models","03_prodInfRSA_prior","data","emp_comprehension_data.csv"))

df_comprehension = df_comprehension_import %>% 
  separate(target, c(NA, "targetType"), sep="_") %>% 
  separate(comp, c(NA, "compType"), sep="_") %>% 
  # select(condition, timeStep_selec, clickedType, obj_in_display, clicked, target, comp, pos1, pos2, pos3, pos4, anon_worker_id, trial_number, prior) %>% 
  # exclude trials with wrong selection after adj
  filter(!(timeStep_selec == "selectedItem1" & !(clickedType == "target" | clickedType == "comp")),
         obj_in_display == "target" | obj_in_display == "comp") %>% 
  mutate_at(vars(obj_in_display_diff), funs(fct_relevel(., "target"))) %>% 
  mutate_at(vars(condition), 
            funs(factor(., levels=c("ttn", "aan", "tan", "atn", 
                                    "ttp", "aap", "tap", "atp")))) %>% 
  mutate(obj_typ = case_when(
    obj_in_display_diff == "target" ~ str_sub(condition,1,1),
    obj_in_display_diff == "comp" ~ str_sub(condition,2,2),
    T ~ "other"
  )) %>% 
  mutate_at(vars(obj_in_display), funs(ifelse(.=="comp", "competitor", .))) %>% 
  # rename(intended_target = clickedType) %>% 
  mutate(dataType = "emp_comprehension")
  # # encode position of target and competitor
  # mutate(pos_target = ifelse(pos1 == "target" | pos2 == "target", T, F)) %>%
  # mutate(pos_comp = ifelse(pos1 == "comp" | pos2 == "comp", T, F)) %>%
  # mutate(pos = case_when(
  #   (pos_target & pos_comp) | (!pos_target & !pos_comp) ~ "equal",
  #   pos_target ~ "target_pref",
  #   TRUE ~ "comp_pref"
  # )) %>% 
  # select(-pos1, -pos2, -pos3, -pos4, -pos_target, -pos_comp)

# imports production data
# only has typeOnly and colorType utterances
# only has the critical trials where the speaker refers to target or comp
# already excluded trials where the listener clicked the wrong object (unsuccessful utterance)
df_production_import = read_csv(here("models","03_prodInfRSA_prior","data","emp_production_data.csv")) %>% 
  # because we filtered for typeOnly and colorType utterances, 
  # ColorMention is only 1 for colorType utterances
  mutate(ColorMention = ifelse(UtteranceCat=="colorType",1,0)) 
  # mutate_at(vars(condition), funs(as.character(.)))
  # select(intended_target, condition, targetType, compType, ColorMention)

# target and comp probability do NOT add up to 1 (not normalized yet)
df_prodprob = df_production_import %>% 
  group_by(condition, intended_target, targetType, compType) %>% 
  summarize(ProbColMention = mean(ColorMention)) %>% 
  ungroup() %>% 
  rename(obj_in_display = intended_target)
```


# Comprehension data

```{r}

# target and comp prob add up to 1, since they were the only options
df_afteradj_prop = df_comprehension %>% 
  filter(category == "nopreadj_critical") %>% 
  group_by(condition, obj_in_display, targetType, compType, prior, obj_typ) %>% 
  summarize(PropClicks = mean(clicked)) %>% 
  ungroup() %>% 
  spread(prior, PropClicks) %>% 
  rename(emp = none,
         emp_normalprior = normal,
         emp_weirdprior = weird)

# df_afteradj_propTarget = df_afteradj_prop %>% 
#   filter(obj_in_display == "target") %>% 
#   select(condition, PropClicks, targetType, compType, prior)

```

<!-- # RSA: flat prior data -->

<!-- ```{r} -->

<!-- df_rsa_flatprior = df_prodprob %>%  -->
<!--   group_by(condition, targetType, compType) %>%  -->
<!--   mutate(norm = sum(ProbColMention)) %>%  -->
<!--   ungroup() %>%  -->
<!--   mutate(RSA_noprior = ProbColMention / norm) %>% -->
<!--   select(condition, RSA_noprior, targetType, compType, obj_in_display) -->

<!-- ``` -->

# RSA

```{r}

# TODO: there is a way to make this more concise

# create preadj selection data frames for the diffeent prior conditions
df_preadj_flatprior = df_comprehension %>%
  select(prior, category, obj_in_display, clickedType, clicked, targetType, compType, condition) %>% 
  filter(prior == "none",
         category == "preadj_selections",
         clickedType == "target" | clickedType == "comp") %>% 
  group_by(condition, targetType, compType, obj_in_display) %>% 
  summarize(flatprior_preadj_targetsel = mean(clicked)) %>% 
  ungroup()

df_preadj_normalprior = df_comprehension %>%
  select(prior, category, obj_in_display, clickedType, clicked, targetType, compType, condition) %>% 
  filter(prior == "normal",
         category == "preadj_selections",
         clickedType == "target" | clickedType == "comp") %>% 
  group_by(condition, targetType, compType, obj_in_display) %>% 
  summarize(normalprior_preadj_targetsel = mean(clicked)) %>% 
  ungroup()

df_preadj_weirdprior = df_comprehension %>%
  select(prior, category, obj_in_display, clickedType, clicked, targetType, compType, condition) %>% 
  filter(prior == "weird",
         category == "preadj_selections",
         clickedType == "target" | clickedType == "comp") %>% 
  group_by(condition, targetType, compType, obj_in_display) %>% 
  summarize(weirdprior_preadj_targetsel = mean(clicked)) %>% 
  ungroup()

# create RSA predictions for each target-comp pair
df_rsa = df_prodprob %>% 
  left_join(df_preadj_flatprior) %>%
  left_join(df_preadj_normalprior) %>%
  left_join(df_preadj_weirdprior) %>%
  group_by(condition, targetType, compType) %>% 
  mutate(norm_noprior = sum(ProbColMention),
         norm_flatprior = sum(ProbColMention * flatprior_preadj_targetsel),
         norm_normalprior = sum(ProbColMention * normalprior_preadj_targetsel),
         norm_weirdprior = sum(ProbColMention * weirdprior_preadj_targetsel)) %>% 
  ungroup() %>% 
  mutate(RSA_noprior = (ProbColMention) / norm_noprior,
         RSA_flatprior = (ProbColMention * flatprior_preadj_targetsel) / norm_flatprior,
         RSA_normalprior = (ProbColMention * normalprior_preadj_targetsel) / norm_normalprior,
         RSA_weirdprior = (ProbColMention * weirdprior_preadj_targetsel) / norm_weirdprior)
  # select(condition, targetType, compType, obj_in_display)

# merge comprehension results with model predictions
df_full = df_rsa %>%
  left_join(df_afteradj_prop) %>% 
  mutate_at(vars(condition), funs(fct_relevel(., "ttn", "aan", "tan", "atn", "ttp", "aap", "tap", "atp"))) %>% 
  mutate_at(vars(obj_in_display), funs(fct_relevel(., "target", "competitor")))

```

# Plots

## Prior manipulation

```{r}
# df_afteradj_prop %>% 
#   filter(prior == "none",
#          category == "nopreadj_critical") %>% 
#   select(-prior, -category) %>% 
#   rename(Probability = PropClicks) %>% 
#   bind_rows(df_rsa_flatprior) %>% 
#   mutate(obj_typ = case_when(
#     obj_in_display == "target" ~ str_sub(condition,1,1),
#     obj_in_display == "competitor" ~ str_sub(condition,2,2),
#     T ~ "other"
#   )) %>% 


df_full %>% 
  select(obj_in_display, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior, condition, obj_typ) %>% 
  filter(obj_in_display == "target") %>% 
  gather(data, proportion, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior) %>% 
  mutate(prior_cond = case_when(
    data == "emp" | data == "RSA_noprior" ~ "no prior",
    data == "emp_normalprior" | data == "RSA_normalprior" ~ "normal prior",
    data == "emp_weirdprior" | data == "RSA_weirdprior" ~ "weird prior",
    TRUE ~ "FIRE"
  )) %>% 
  # filter(condition %in% c("tan", 'atn', 'tap', 'atp')) %>%
  mutate_at(vars(data), funs(fct_relevel(., "RSA_noprior", "RSA_normalprior", "RSA_weirdprior", "emp", "emp_normalprior", "emp_weirdprior"))) %>% 
  ggplot(., aes(x=prior_cond, 
                y=proportion, 
                fill=data)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.7),
               color="black",
               size=0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  scale_fill_manual(values=c("#d8d8d8", "#99d6cf", "#f8c8ad", "#808080", "#009988", "#ee7733")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  theme(axis.title = element_text(size=16)) +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","results_prior_full.png"), height=5, width=7, bg="transparent")
# ggsave(here("analyses","full_analysis","graphs","results_prior.png"), height=5.5, width=6, bg="transparent")

```

```{r}


df_full %>% 
  select(obj_in_display, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior, condition, obj_typ) %>% 
  filter(obj_in_display == "target") %>% 
  gather(data, proportion, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior) %>% 
  mutate(prior_cond = case_when(
    data == "emp" | data == "RSA_noprior" ~ "no prior",
    data == "emp_normalprior" | data == "RSA_normalprior" ~ "normal prior",
    data == "emp_weirdprior" | data == "RSA_weirdprior" ~ "weird prior",
    TRUE ~ "FIRE"
  )) %>% 
  # filter(condition %in% c("tan", 'atn', 'tap', 'atp')) %>%
  mutate_at(vars(data), funs(fct_relevel(., "RSA_noprior", "RSA_normalprior", "RSA_weirdprior", "emp", "emp_normalprior", "emp_weirdprior"))) %>% 
  filter(str_detect(data, "emp")) %>% 
  mutate(converged_condition = case_when(
    condition == "ttn" | condition == "aan" | condition == "ttp" | condition == "aap" ~ "same typ",
    condition == "tan" | condition == "atn" | condition == "tap" | condition == "atp" ~ "diff typ",
    TRUE ~ "FIRE"
  )) %>% 
  mutate(converged_proportion = case_when(
    condition == "ttn"  ~ proportion,
    condition == "aan"  ~ proportion,
    condition == "tan" ~ proportion,
    condition == "atn" ~ 1-proportion,
    condition == "tap" ~ proportion,
    condition == "atp" ~ 1-proportion,
    condition == "ttp" ~ proportion,
    condition == "aap" ~ proportion,
    TRUE ~ 42
  )) %>% 
  filter(data!="emp") %>%
  ggplot(., aes(x=obj_typ, 
                y=proportion, 
                fill=prior_cond)) +
  facet_wrap(~converged_condition, scales = "free_x", nrow=1) +
  # geom_point(alpha = 0.4, position = position_dodge(width=0.3)) +
  stat_summary(fun = "mean", 
               geom = "bar",
               position = position_dodge(width=0.7),
               width = 0.6,
               color = "black",
               size = 0.5) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               position = position_dodge(width=0.7),
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  scale_fill_manual(values=c("#009988", "#ee7733")) +
  scale_color_manual(values=c("#009988", "#ee7733")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  theme(axis.title = element_text(size=16)) +
  ylab("Proportion of selections")

# ggsave("prior_mainresults.png", height=3.5, width=6, bg="transparent")

```


```{r}
# df_afteradj_prop %>% 
#   filter(prior == "none",
#          category == "nopreadj_critical") %>% 
#   select(-prior, -category) %>% 
#   rename(Probability = PropClicks) %>% 
#   bind_rows(df_rsa_flatprior) %>% 
#   mutate(obj_typ = case_when(
#     obj_in_display == "target" ~ str_sub(condition,1,1),
#     obj_in_display == "competitor" ~ str_sub(condition,2,2),
#     T ~ "other"
#   )) %>% 


df_full %>% 
  select(obj_in_display, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior, condition, obj_typ) %>% 
  filter(obj_in_display == "target") %>% 
  gather(emp_data, emp_proportion, emp, emp_normalprior, emp_weirdprior) %>% 
  gather(rsa_data, rsa_proportion, RSA_noprior, RSA_normalprior, RSA_weirdprior) %>% 
  mutate(source_conc = str_c(emp_data, rsa_data, sep = ":")) %>% 
  filter(source_conc == "emp:RSA_noprior" | source_conc == "emp_normalprior:RSA_normalprior" | source_conc == "emp_weirdprior:RSA_weirdprior" ) %>% 
  mutate(prior_cond = case_when(
    emp_data == "emp" ~ "no prior",
    emp_data == "emp_normalprior" ~ "normal prior",
    emp_data == "emp_weirdprior" ~ "weird prior",
    TRUE ~ "FIRE"
  )) %>% 
  # group_by(condition, prior_cond) %>% 
  # summarize(mean_emp = mean(emp_proportion),
  #           mean_rsa = mean(rsa_proportion)) %>% 
  # ungroup() %>% 
  # mutate_at(vars(data), funs(fct_relevel(., "RSA_noprior", "RSA_normalprior", "RSA_weirdprior", "emp", "emp_normalprior", "emp_weirdprior"))) %>% 
  ggplot(., aes(x=prior_cond, 
                y=emp_proportion, 
                color=prior_cond)) +
  geom_point(alpha = 0.3) +
  # geom_smooth(method = "lm") +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean",
               geom = "point",
               size = 3) +
  # stat_summary(fun.data = "mean_cl_boot",
  #              geom = "errorbar",
  #              color = "black",
  #              position = position_dodge(width = 0.7),
  #              size = .3,
  #              width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  scale_fill_manual(values=c("#d8d8d8", "#99d6cf", "#f8c8ad", "#808080", "#009988", "#ee7733")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  theme(axis.title = element_text(size=16))
  # ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","results_prior_full.png"), height=5, width=7, bg="transparent")
# ggsave(here("analyses","full_analysis","graphs","results_prior.png"), height=5.5, width=6, bg="transparent")

```



## TAN condition

```{r}


df_full %>% 
  select(obj_in_display, RSA_noprior, RSA_normalprior, RSA_weirdprior, condition, obj_typ) %>% 
  filter(condition == "tan") %>% 
  gather(data, proportion, RSA_noprior, RSA_normalprior, RSA_weirdprior) %>% 
  mutate(prior_cond = case_when(
    data == "emp" | data == "RSA_noprior" ~ "no prior",
    data == "emp_normalprior" | data == "RSA_normalprior" ~ "normal prior",
    data == "emp_weirdprior" | data == "RSA_weirdprior" ~ "weird prior",
    TRUE ~ "FIRE"
  )) %>% 
  mutate_at(vars(data), funs(fct_relevel(., "RSA_noprior", "RSA_normalprior", "RSA_weirdprior", "emp", "emp_normalprior", "emp_weirdprior"))) %>% 
  ggplot(., aes(x=obj_in_display, 
                y=proportion)) +
  facet_wrap(~prior_cond, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.7),
               fill="#7F93B5",
               color="black",
               size=0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  # scale_alpha_manual(values=c(1, 0.5)) +
  # scale_fill_manual(values=c("#d8d8d8", "#99d6cf", "#f8c8ad", "#808080", "#009988", "#ee7733")) +
  # scale_x_discrete(labels=c("comp"="competitor")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()) +
  theme(axis.title = element_text(size=16)) +
  ylab("Proportion of selections")

# ggsave("tan_condition_criticallistener.png", height=3.5, width=4, bg="transparent")

```
## Correlations

```{r}

scatter_plot = function(data1, data2) {
  df_rsacor_noprior = df_full %>%  
    filter(obj_in_display == "target") %>% 
    gather(data, proportion, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior) %>%
    select(condition, data, proportion) %>%
    filter(data == data1 | data == data2) %>% 
    group_by(condition, data) %>% 
    summarize(mean=mean(proportion, na.rm=TRUE),
              CI_low_diff=ci.low(proportion),
              CI_high_diff=ci.high(proportion)) %>% 
    ungroup() %>%
    mutate(CI_low = mean-CI_low_diff) %>% 
    mutate(CI_high = mean+CI_high_diff) %>% 
    select(data, condition, mean, CI_low, CI_high)
  
  # view(df_rsacor_noprior)
  
  emp_data = df_rsacor_noprior %>% 
    filter(data == data1) %>% 
    rename(mean_emp=mean,
           CI_low_emp=CI_low,
           CI_high_emp=CI_high) %>% 
    select(-data)
  
  rsa_data = df_rsacor_noprior %>% 
    filter(data == data2) %>% 
    rename(mean_rsa=mean,
           CI_low_rsa=CI_low,
           CI_high_rsa=CI_high) %>% 
    select(-data)
  
  merged_data = emp_data %>% 
    left_join(rsa_data, by="condition")
  
  # view(merged_data)
  
  df_points = df_full %>% 
    rename("data1" = data1,
           "data2" = data2)

  plot = ggplot(merged_data, aes(x=mean_rsa, y=mean_emp, color=condition)) +
    geom_point(data=filter(df_points, obj_in_display=="target"),
               aes(x=data1, y=data2, color=condition),
               alpha=0.2) +
    geom_errorbar(aes(ymin = CI_low_emp, ymax = CI_high_emp),
                  width=0) +
    geom_errorbarh(aes(xmin = CI_low_rsa, xmax = CI_high_rsa),
                   height=0) +
    geom_point(size=2.5) +
    coord_cartesian(xlim = c(0,1), ylim = c(0,1)) +
    scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
    xlab("Model prediction") +
    ylab("Empirical proportion of\ntarget selections")
  
  print(data1)
  print(data2)
  print("all data:")
  print(cor(df_points$data1, df_points$data2, use="complete.obs"))
  print("condition means only:")
  print(cor(merged_data$mean_rsa, merged_data$mean_emp, use="complete.obs"))
  
  return(plot)
}


noprior_plot = scatter_plot("RSA_noprior", "emp")
# all data: 0.6625; condition means only: 0.9208
noprior_plot
normalprior_plot = scatter_plot("RSA_normalprior", "emp_normalprior")
# all data: 0.1951; condition means only: 0.3620
normalprior_plot
weirdprior_plot = scatter_plot("RSA_weirdprior", "emp_weirdprior")
# all data: 0.2806; condition means only: 0.8113
weirdprior_plot

rsauni_normalprior_plot = scatter_plot("RSA_noprior", "emp_normalprior")
# all data: 0.0846; condition means only: -0.2475
rsauni_normalprior_plot
rsauni_weirdprior_plot = scatter_plot("RSA_noprior", "emp_weirdprior")
# all data: 0.2969; condition means only: 0.5846
rsauni_weirdprior_plot

emp_no_normal_plot = scatter_plot("emp", "emp_normalprior")
# all data: 0.1510; condition means only: -0.3952
emp_no_normal_plot
emp_no_weird_plot = scatter_plot("emp", "emp_weirdprior")
# all data: 0.3921; condition means only: 0.7957
emp_no_weird_plot

weirdrsa_normalemp_plot = scatter_plot("RSA_weirdprior", "emp")
# all data: 0.4442; condition means only: 0.9935
weirdrsa_normalemp_plot

# ggsave(plot=noprior_plot, filename=here("cor_noprior_plot.png"), height=3.5, width=4.9)
# ggsave(plot=normalprior_plot, filename=here("cor_normalprior_plot.png"), height=3.5, width=4.9)
# ggsave(plot=weirdprior_plot, filename=here("cor_weirdprior_plot.png"), height=3.5, width=4.9)
# ggsave(plot=rsauni_normalprior_plot, filename=here("cor_rsauni_normalprior_plot.png"), height=3.5, width=4.9)
# ggsave(plot=rsauni_weirdprior_plot, filename=here("cor_rsauni_weirdprior_plot.png"), height=3.5, width=4.9)
# ggsave(plot=emp_no_normal_plot, filename=here("cor_emp_no_normal_plot.png"), height=3.5, width=4.9)
# ggsave(plot=emp_no_weird_plot, filename=here("cor_emp_no_weird_plot.png"), height=3.5, width=4.9)
# ggsave(plot=weirdrsa_normalemp_plot, filename=here("cor_weirdrsa_normalemp_plot.png"), height=3.5, width=4.9)
# 
# df_rsacor_noprior = df_full %>%  
#   filter(obj_in_display == "target") %>% 
#   select(condition, emp, RSA_noprior) %>% 
#   group_by(condition) %>% 
#   summarize(meanemp=mean(emp),
#             emp_CI_low_diff=ci.low(emp),
#             emp_CI_high_diff=ci.high(emp),
#             meanRSA=mean(RSA_noprior),
#             RSA_CI_low_diff=ci.low(RSA_noprior),
#             RSA_CI_high_diff=ci.high(RSA_noprior)) %>% 
#   ungroup() %>%
#   mutate(RSA_CI_low = meanRSA-RSA_CI_low_diff) %>% 
#   mutate(RSA_CI_high = meanRSA+RSA_CI_high_diff) %>% 
#   mutate(emp_CI_low = meanemp-emp_CI_low_diff) %>% 
#   mutate(emp_CI_high = meanemp+emp_CI_high_diff)
# 
# ggplot(df_rsacor_noprior, aes(x=meanRSA, y=meanemp, color=condition)) +
#   geom_point(data=filter(df_full, obj_in_display=="target"),
#              aes(x=RSA_noprior, y=emp, color=condition),
#              alpha=0.2) +
#   geom_errorbar(aes(ymin = emp_CI_low, ymax = emp_CI_high),
#                 width=0) + 
#   geom_errorbarh(aes(xmin = RSA_CI_low, xmax = RSA_CI_high),
#                  height=0) +
#   geom_point(size=2.5) +
#   coord_cartesian(xlim = c(0,1), ylim = c(0,1)) +
#   scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
#   xlab("Model prediction") +
#   ylab("Empirical proportion of\ntarget selections")
# 
# df_corr = df_full %>% 
#   select(obj_in_display, RSA_noprior, emp, RSA_normalprior, emp_normalprior, RSA_weirdprior, emp_weirdprior, condition, obj_typ) %>% 
#   filter(obj_in_display == "target")
# 
# cor(df_corr$RSA_noprior, df_corr$emp)
# cor(df_rsacor_noprior$meanRSA, df_rsacor_noprior$meanemp)

```
```{r}
df_vanilla_emp_noprior = df_full %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, emp) %>% 
  left_join(df_simple, by="condition") %>% 
  group_by(condition) %>% 
  summarize(emp_mean = mean(emp),
            vanilla_mean = mean(proportion)) %>%
  ungroup()
# view(df_vanilla_emp_noprior)
print(cor(df_vanilla_emp_noprior$emp_mean, df_vanilla_emp_noprior$vanilla_mean, use="complete.obs"))

df_default_emp_noprior = df_full %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, emp) %>% 
  left_join(df_default, by="condition") %>% 
  group_by(condition) %>% 
  summarize(emp_mean = mean(emp),
            default_mean = mean(proportion)) %>%
  ungroup()
# view(df_default_emp_noprior)
print(cor(df_default_emp_noprior$emp_mean, df_default_emp_noprior$default_mean, use="complete.obs"))

df_RSA_emp_noprior = df_full %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, emp, RSA_noprior, RSA_flatprior) %>% 
  group_by(condition) %>% 
  summarize(emp_mean = mean(emp),
            RSA_noprior_mean = mean(RSA_noprior),
            RSA_flatprior_mean = mean(RSA_flatprior)) %>%
  ungroup()
print(cor(df_RSA_emp_noprior$emp_mean, df_RSA_emp_noprior$RSA_noprior_mean, use="complete.obs"))
print(cor(df_RSA_emp_noprior$emp_mean, df_RSA_emp_noprior$RSA_flatprior_mean, use="complete.obs"))
```


# model comp

```{r}

df_simple = tibble(condition = c("atp","ttp","aap","tap","atn","ttn","aan","tan"),
                   proportion = c(1,1,1,1,0.5,0.5,0.5,0.5)) %>% 
  mutate(data = "vanilla",
         obj_in_display = "target")

df_default = tibble(condition = c("atp","ttp","aap","tap","atn","ttn","aan","tan"),
                    proportion = c(0.5,1,0.5,1,0.5,0.5,0.5,0.5)) %>% 
  mutate(data = "default",
         obj_in_display = "target")

df_full %>% 
  select(obj_in_display, RSA_noprior, emp, condition) %>% 
  filter(obj_in_display == "target") %>% 
  gather(data, proportion, RSA_noprior, emp) %>% 
  bind_rows(df_simple) %>% 
  bind_rows(df_default) %>% 
  mutate_at(vars(data), funs(fct_relevel(., "vanilla", "default", "RSA_noprior","emp"))) %>% 
  mutate_at(vars(condition), funs(fct_relevel(., "ttn", "aan", "tan", "atn", "ttp", "aap", "tap", "atp"))) %>% 
  ggplot(., aes(x=obj_in_display, 
                y=proportion, 
                fill=data)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.7),
               color="black",
               size=0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  # scale_alpha_manual(values=c(1, 0.5)) +
  scale_fill_manual(values=c("#CBD3E1", "#A5B3CB", "#7F93B5", "#808080")) +
  # scale_x_discrete(labels=c("comp"="competitor")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()
        ) +
  theme(axis.title = element_text(size=16)) +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","modelcomp_wemp_noprior_bar.png"), height=4, width=6, bg="transparent")

df_full %>% 
  select(obj_in_display, RSA_noprior, condition) %>% 
  filter(obj_in_display == "target") %>% 
  gather(data, proportion, RSA_noprior) %>% 
  bind_rows(df_simple) %>% 
  bind_rows(df_default) %>% 
  mutate_at(vars(data), funs(fct_relevel(., "vanilla", "default", "RSA_noprior"))) %>% 
  mutate_at(vars(condition), funs(fct_relevel(., "ttn", "aan", "tan", "atn", "ttp", "aap", "tap", "atp"))) %>% 
  ggplot(., aes(x=obj_in_display, 
                y=proportion, 
                fill=data)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.7),
               color="black",
               size=0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  # scale_alpha_manual(values=c(1, 0.5)) +
  scale_fill_manual(values=c("#CBD3E1", "#A5B3CB", "#7F93B5")) +
  # scale_x_discrete(labels=c("comp"="competitor")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.x = element_blank()
        ) +
  theme(axis.title = element_text(size=16)) +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","modelcomp_noprior_bar.png"), height=4, width=7, bg="transparent")
```

# RSA scatter

```{r}

source(here("models","02_prodInfRSA","helpers.r"))

df_rsacor_noprior = df_full %>%  
  filter(obj_in_display == "target") %>% 
  select(condition, emp, RSA_noprior) %>% 
  group_by(condition) %>% 
  summarize(meanemp=mean(emp),
            emp_CI_low_diff=ci.low(emp),
            emp_CI_high_diff=ci.high(emp),
            meanRSA=mean(RSA_noprior),
            RSA_CI_low_diff=ci.low(RSA_noprior),
            RSA_CI_high_diff=ci.high(RSA_noprior)) %>% 
  ungroup() %>%
  mutate(RSA_CI_low = meanRSA-RSA_CI_low_diff) %>% 
  mutate(RSA_CI_high = meanRSA+RSA_CI_high_diff) %>% 
  mutate(emp_CI_low = meanemp-emp_CI_low_diff) %>% 
  mutate(emp_CI_high = meanemp+emp_CI_high_diff)

ggplot(df_rsacor_noprior, aes(x=meanRSA, y=meanemp, color=condition)) +
  geom_point(data=filter(df_full, obj_in_display=="target"),
             aes(x=RSA_noprior, y=emp, color=condition),
             alpha=0.2) +
  geom_errorbar(aes(ymin = emp_CI_low, ymax = emp_CI_high),
                width=0) + 
  geom_errorbarh(aes(xmin = RSA_CI_low, xmax = RSA_CI_high),
                 height=0) +
  geom_point(size=2.5) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,1)) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

# no prior, by item
cor(filter(df_full, obj_in_display=="target")$RSA_noprior,filter(df_full, obj_in_display=="target")$emp)
# no prior, by condition
cor(df_rsacor_noprior$meanRSA,df_rsacor_noprior$meanemp)

# ggsave(here("analyses","full_analysis","graphs","rsa_noprior_scatter.png"), height=4, width=6)

df_rsacor_normalprior = df_full %>%  
  filter(obj_in_display == "target") %>% 
  select(condition, emp_normalprior, RSA_normalprior) %>% 
  group_by(condition) %>% 
  summarize(meanemp=mean(emp_normalprior),
            emp_CI_low_diff=ci.low(emp_normalprior),
            emp_CI_high_diff=ci.high(emp_normalprior),
            meanRSA=mean(RSA_normalprior, na.rm=TRUE),
            RSA_CI_low_diff=ci.low(RSA_normalprior),
            RSA_CI_high_diff=ci.high(RSA_normalprior)) %>% 
  ungroup() %>%
  mutate(RSA_CI_low = meanRSA-RSA_CI_low_diff) %>% 
  mutate(RSA_CI_high = meanRSA+RSA_CI_high_diff) %>% 
  mutate(emp_CI_low = meanemp-emp_CI_low_diff) %>% 
  mutate(emp_CI_high = meanemp+emp_CI_high_diff)

ggplot(df_rsacor_normalprior, aes(x=meanRSA, y=meanemp, color=condition)) +
  geom_point(data=filter(df_full, obj_in_display=="target"),
             aes(x=RSA_normalprior, y=emp_normalprior, color=condition),
             alpha=0.2) +
  geom_errorbar(aes(ymin = emp_CI_low, ymax = emp_CI_high),
                width=0) + 
  geom_errorbarh(aes(xmin = RSA_CI_low, xmax = RSA_CI_high),
                 height=0) +
  geom_point(size=2.5) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,1)) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

# no prior, by item
cor(filter(df_full, obj_in_display=="target")$RSA_normalprior,filter(df_full, obj_in_display=="target")$emp_normalprior,use="complete.obs")
# no prior, by condition
cor(df_rsacor_normalprior$meanRSA,df_rsacor_normalprior$meanemp)

df_rsacor_weirdprior = df_full %>%  
  filter(obj_in_display == "target") %>% 
  select(condition, emp_weirdprior, RSA_weirdprior) %>% 
  group_by(condition) %>% 
  summarize(meanemp=mean(emp_weirdprior),
            emp_CI_low_diff=ci.low(emp_weirdprior),
            emp_CI_high_diff=ci.high(emp_weirdprior),
            meanRSA=mean(RSA_weirdprior, na.rm=TRUE),
            RSA_CI_low_diff=ci.low(RSA_weirdprior),
            RSA_CI_high_diff=ci.high(RSA_weirdprior)) %>% 
  ungroup() %>%
  mutate(RSA_CI_low = meanRSA-RSA_CI_low_diff) %>% 
  mutate(RSA_CI_high = meanRSA+RSA_CI_high_diff) %>% 
  mutate(emp_CI_low = meanemp-emp_CI_low_diff) %>% 
  mutate(emp_CI_high = meanemp+emp_CI_high_diff)

ggplot(df_rsacor_weirdprior, aes(x=meanRSA, y=meanemp, color=condition)) +
  geom_point(data=filter(df_full, obj_in_display=="target"),
             aes(x=RSA_normalprior, y=emp_normalprior, color=condition),
             alpha=0.2) +
  geom_errorbar(aes(ymin = emp_CI_low, ymax = emp_CI_high),
                width=0) + 
  geom_errorbarh(aes(xmin = RSA_CI_low, xmax = RSA_CI_high),
                 height=0) +
  geom_point(size=2.5) +
  coord_cartesian(xlim = c(0,1), ylim = c(0,1)) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

# no prior, by item
cor(filter(df_full, obj_in_display=="target")$RSA_weirdprior,filter(df_full, obj_in_display=="target")$emp_weirdprior,use="complete.obs")
# no prior, by condition
cor(df_rsacor_weirdprior$meanRSA,df_rsacor_weirdprior$meanemp)
```


```{r}
# COGSCI plot

source(here("models","02_prodInfRSA","helpers.r"))

df_cor_flatprior = df_afteradj_prop %>% 
  filter(prior == "none",
         category == "nopreadj_critical") %>% 
  select(-prior, -category) %>% 
  rename(dataType_emp = dataType) %>% 
  left_join(df_rsa_flatprior) %>% 
  filter(obj_in_display == "target") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks=mean(PropClicks),
            prop_CI_low_diff=ci.low(PropClicks),
            prop_CI_high_diff=ci.high(PropClicks),
            meanProb=mean(Probability),
            prob_CI_low_diff=ci.low(Probability),
            prob_CI_high_diff=ci.high(Probability)) %>% 
  ungroup() %>% 
  mutate(prob_CI_low = meanProb-prob_CI_low_diff) %>% 
  mutate(prob_CI_high = meanProb+prob_CI_high_diff) %>% 
  mutate(prop_CI_low = meanPropClicks-prop_CI_low_diff) %>% 
  mutate(prop_CI_high = meanPropClicks+prop_CI_high_diff) %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

glimpse(df_cor_flatprior)

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("writing","2020_CogSci","paper","graphs","corr-modelflat-bycondition.pdf"), width = 5.5, height = 3)

```

```{r}

df_cor_flatprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup() %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

# df_cor_flatprior

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

# df_cor_flatprior %>% 
#   select(condition,meanProb,meanPropClicks)

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("corr-modelflat-bycondition.pdf"), width = 6, height = 3.5)

```

### Flat prior + pos

```{r}

df_cor_flatprior = df_afteradjpos_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition, pos) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup() %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

# df_cor_flatprior

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=pos)) +
  geom_smooth(method="lm") +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  # scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("writing", "2020_CogSci", "paper", "graphs", "corr-modelflat-bycondition.pdf"), width = 6, height = 3.5)

```

### Flat prior + prev click & pos

```{r}

df_cor_prevposflat = df_prevpos_propTarget %>% 
  left_join(df_rsa_flatpriorTarget)  %>% 
  filter(prior=="weird") %>% 
  group_by(condition, pos, prevClickedType) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# view(df_cor_prevposflat)

df_cor_prevposflat %>% 
  # filter(n_compr > 4) %>% 
  filter(pos == "equal") %>%
  # filter(prevClickedType == "other") %>%
ggplot(., aes(x=meanProb, y=meanPropClicks, color=condition)) +
  facet_wrap(~prevClickedType, nrow=3) +
  # facet_wrap(~pos) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

df_corcalc = df_cor_prevposflat %>% 
  filter(pos == "equal") %>%
  filter(prevClickedType == "other")

cor(df_corcalc$meanProb,df_corcalc$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```

### Simple prior

```{r}

df_cor_simpprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget) %>% 
  filter(prior=="normal") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# df_cor_simpprior

ggplot(df_cor_simpprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_simpprior$meanProb,df_cor_simpprior$meanPropClicks)

df_cor_simpprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# df_cor_simpprior

ggplot(df_cor_simpprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_simpprior$meanProb,df_cor_simpprior$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```


### Prior + prev click & pos

```{r}

df_cor_prevposprior = df_prevpos_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget)  %>% 
  group_by(condition, pos, prevClickedType) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

view(df_cor_prevposprior)

df_cor_prevposprior %>% 
  # filter(n_compr > 4) %>% 
  filter(pos == "equal") %>%
  # filter(prevClickedType == "other") %>%
ggplot(., aes(x=meanProb, y=meanPropClicks, color=condition)) +
  facet_wrap(~prevClickedType, nrow=3) +
  # facet_wrap(~pos) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

df_corcalc = df_cor_prevposprior %>% 
  filter(pos == "equal") %>%
  filter(prevClickedType == "other")

cor(df_corcalc$meanProb,df_corcalc$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```

## Empirical vs. condition

### Flat prior

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prior=="normal") %>% 
  # filter(str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  # theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no_preadj_model.pdf"), width = 8, height = 5)
# ggsave(here("preadj_model.pdf"), width = 8, height = 5)

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prior=="weird") %>% 
  # filter(str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  # theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no_preadj_model.pdf"), width = 8, height = 5)
# ggsave(here("preadj_model.pdf"), width = 8, height = 5)

```

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no-preadj-flatprior-contrast.pdf"), width = 8, height = 3)
ggsave(here("preadj-flatprior-contrast.pdf"), width = 8, height = 3)

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(!str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no-preadj-flatprior-nocontrast.pdf"), width = 8, height = 3)
ggsave(here("preadj-flatprior-nocontrast.pdf"), width = 8, height = 3)
```

##### CUNY poster plot

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  filter(Measure == "Model predictions")

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=intended_target
                # alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.6),
               width = 0.6) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.6),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_fill_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("modelpred-contrast.pdf"), width = 8, height = 3)

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(!str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=intended_target
                # alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.6),
               width = 0.6) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.6),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_fill_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("modelpred-nocontrast.pdf"), width = 8, height = 3)
```

### Flat prior + prev click & pos

```{r}

df_full = df_prevpostClick %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior)  %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  filter(pos == "equal") %>%
  filter(prevClickedType == "other") %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("writing", "2020_CogSci", "paper", "graphs", "modelflat-bycondition-targetprevClick.pdf"), width = 8, height = 6)

```

### Simple prior

```{r shiny data creation}
df_model_pred_flatprior = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_prior_aggr, by=(c("condition", "targetType", "compType", "intended_target", "prior"))) %>% 
  gather(Measure, Value, PropClicks, predProportion) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  filter(Measure == "Model predictions") %>% 
  rename(clicked = "Value") %>% 
  rename(obj_in_display_diff = "intended_target") %>% 
  select(obj_in_display_diff, clicked, condition, prior)

write_csv(df_model_pred_flatprior, "model_prior.csv")
```

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_prior_aggr, by=(c("condition", "targetType", "compType", "intended_target", "prior"))) %>% 
  gather(Measure, Value, PropClicks, predProportion) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prior=="normal") %>% 
  # filter(prioredContext == "both_priored") %>% 
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("priormanipulation_itemprior_both.pdf"), width = 8, height = 6)
```

### Prior + prev click & pos

```{r}

df_full = df_prevpostClick %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior)  %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  # filter(pos == "equal") %>%
  filter(prevClickedType == "target") %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("writing", "2020_CogSci", "paper", "graphs", "modelflat-bycondition-targetprevClick.pdf"), width = 8, height = 6)

```







# Archive



## Comprehension data with pos

```{r}

df_afteradjpos_prop = df_afteradj_selections %>% 
  group_by(condition, obj_in_display, targetType, compType, pos, prior) %>% 
  summarize(PropClicks = mean(clicked)) %>% 
  ungroup() %>% 
  select(condition, PropClicks, targetType, compType, obj_in_display, pos, prior)

df_afteradjpos_propTarget = df_afteradjpos_prop %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, PropClicks, targetType, compType, pos, prior)

```

## Comprehension data with prev click and pos

```{r}

# extract prior from comprehension data
df_beforeadj = df_comprehension %>% 
  # only clicks before adjective
  filter(timeStep_selec == "selectedItem_prior")

# prevClick empirical comprehension data
df_prevClick = df_beforeadj %>% 
  rename(prevClickedType = "clickedType") %>% 
  select(prevClickedType, obj_in_display, anon_worker_id, trial_number, prior) %>% 
  mutate_at(vars(prevClickedType), funs(ifelse(. == "contrast/distractor" | . == "distractor", "other", .)))

# full empirical comprehension data
df_prevpostClick = df_afteradj_selections %>%
  select(-timeStep_selec) %>% 
  left_join(df_prevClick) %>% 
  select(condition, clickedType, obj_in_display, clicked, targetType, compType, prevClickedType, pos, prior) %>% 
  group_by(condition, obj_in_display, targetType, compType, prevClickedType, pos, prior) %>%
  # group_by(condition, obj_in_display, targetType, prevClickedType, pos) %>% 
  summarize(PropClicks = mean(clicked),
            n_compr = n()) %>% 
  ungroup() %>% 
  select(condition, PropClicks, targetType, compType, obj_in_display, prevClickedType, pos, n_compr, prior)
  # select(condition, PropClicks, targetType, obj_in_display, prevClickedType, pos, n_compr)

df_prevpos_propTarget = df_prevpostClick %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, PropClicks, targetType, compType, prevClickedType, pos, n_compr, prior)
  # select(condition, PropClicks, targetType, prevClickedType, pos, n_compr)
```


---
title: "RSA simple"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import data and libraries

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(cowplot)
# library(plyr)
library(tidyverse)
library(here)
# library(boot)

theme_set(theme_cowplot())

target_color = "#d55e00" # red
comp_color = "#009e74"

model_color = "#cc79a7" # purple
emp_color = "#0071b2" # blue
  
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

# imports comprehension data (already only critical trials)
df_comprehension_import = read_csv(here("models","03_prodInfRSA_prior","data","emp_comprehension_data.csv"))

df_comprehension = df_comprehension_import %>% 
  # select(condition, timeStep_selec, clickedType, obj_in_display, clicked, target, comp, pos1, pos2, pos3, pos4, anon_worker_id, trial_number, prior) %>% 
  # exclude trials with wrong selection after adj
  filter(!(timeStep_selec == "selectedItem1" & !(clickedType == "target" | clickedType == "comp")))
  # # encode position of target and competitor
  # mutate(pos_target = ifelse(pos1 == "target" | pos2 == "target", T, F)) %>%
  # mutate(pos_comp = ifelse(pos1 == "comp" | pos2 == "comp", T, F)) %>%
  # mutate(pos = case_when(
  #   (pos_target & pos_comp) | (!pos_target & !pos_comp) ~ "equal",
  #   pos_target ~ "target_pref",
  #   TRUE ~ "comp_pref"
  # )) %>% 
  # select(-pos1, -pos2, -pos3, -pos4, -pos_target, -pos_comp)

# imports production data
df_production_import = read_csv(here("models","03_prodInfRSA_prior","data","emp_production_data.csv")) 

# only has typeOnly and colorType utterances
# only has the critical trials where the speaker refers to target or comp
# already excluded trials where the listener clicked the wrong object (unsuccessful utterance)
df_production = df_production_import %>% 
  # because we filtered for typeOnly and colorType utterances, 
  # ColorMention is only 1 for colorType utterances
  mutate(ColorMention = ifelse(UtteranceCat=="colorType",1,0)) %>% 
  select(intended_target, condition, targetType, compType, ColorMention)
```


# Comprehension data

```{r}

df_afteradj_selections = df_comprehension %>% 
  # after adj trials only
  filter(timeStep_selec == "selectedItem1") 
  # filter out incorrect selections
  # filter(clickedType == "target" | clickedType == "comp") %>% 
  # TODO: NECESSARY? target and comp remain the only relevant objects
  # filter(obj_in_display == "target" | obj_in_display == "comp")

# target and comp prob add up to 1, since they were the only options
df_afteradj_prop = df_afteradj_selections %>% 
  group_by(condition, obj_in_display, targetType, compType, prior) %>% 
  summarize(PropClicks = mean(clicked)) %>% 
  ungroup() %>% 
  select(condition, PropClicks, targetType, compType, obj_in_display, prior)

df_afteradj_propTarget = df_afteradj_prop %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, PropClicks, targetType, compType, prior)

```

# Production data

```{r}

# deal with data that needs to be duplicated for no contrast contexts
df_prodcompetitor = df_production %>% 
  filter(str_detect(condition, "n")) %>% 
  mutate(intended_target = "comp") %>% 
  mutate_at(vars(condition), funs(case_when(
    .=="atn" ~ "tan",
    .=="tan" ~ "atn",
    TRUE ~ .
  ))) %>% 
  mutate(targetType_rev = compType) %>% 
  mutate(compType_rev = targetType) %>% 
  select(-targetType, -compType) %>% 
  rename(targetType = "targetType_rev",
         compType = "compType_rev")

df_prod_full = df_production %>% 
  # include duplicated comp data
  bind_rows(df_prodcompetitor)

# target and comp probability do NOT add up to 1 (not normalized yet)
df_prodprob = df_prod_full %>% 
  group_by(condition, intended_target, targetType, compType) %>% 
  summarize(ProbColMention = mean(ColorMention)) %>% 
  ungroup()

```


# RSA: flat prior data

```{r}

df_rsa_flatprior = df_prodprob %>% 
  group_by(condition, targetType, compType) %>% 
  mutate(norm = sum(ProbColMention)) %>% 
  ungroup() %>% 
  mutate(Probability = ProbColMention / norm) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  select(condition, Probability, targetType, compType, intended_target)

df_rsa_flatpriorTarget = df_rsa_flatprior %>% 
  filter(intended_target == "target") %>% 
  select(condition, Probability, targetType, compType)

```


# RSA: inf prior data


## Simple prior

```{r eval=FALSE, include=FALSE}
  
# aggregated prior over all objects in the display
df_prior_aggr = df_beforeadj %>% 
  group_by(condition, obj_in_display, targetType, compType, prior) %>% 
  summarize(PropClicks_prior = mean(clicked)) %>% 
  ungroup() %>% 
  rename(intended_target = "obj_in_display")

# RSA model predictions with aggregated prior
# since the selection probability after adj is 0, contrast and distractor(s) disappear
df_rsa_prior_aggr = df_prodprob %>% 
  left_join(df_prior_aggr) %>% 
  # # typicality prior simulation
  # mutate(PropClicks_prior_sim = case_when(
  #   str_detect(condition, "ta") & intended_target == "target" ~ PropClicks_prior*0.5,
  #   str_detect(condition, "ta") & intended_target == "comp" ~ PropClicks_prior*2,
  #   str_detect(condition, "at") & intended_target == "target" ~ PropClicks_prior*2,
  #   str_detect(condition, "at") & intended_target == "comp" ~ PropClicks_prior*0.5,
  #   TRUE ~ PropClicks_prior
  # )) %>%
  # mutate_at(vars(PropClicks_prior_sim), funs(ifelse(.>1, 1, .))) %>%
  # mutate(weightedProbColMention = ProbColMention * PropClicks_prior_sim) %>%
  # group_by(condition, targetType, compType) %>%
  # mutate(norm = sum(weightedProbColMention)) %>%
  # ungroup() %>%
  # mutate(predProportion = (ProbColMention * PropClicks_prior_sim) / norm) %>%
  #
  # # item prior simulation
  # mutate(PropClicks_prior_sim = case_when(
  #   (targetType == "banana" | targetType == "carrot" | targetType == "egg") & intended_target == "target" ~ PropClicks_prior*2,
  #   (compType == "banana" | compType == "carrot" | compType == "egg") & intended_target == "target" ~ PropClicks_prior*0.5,
  #   TRUE ~ PropClicks_prior
  # )) %>%
  # mutate_at(vars(PropClicks_prior_sim), funs(ifelse(.>1, 1, .))) %>%
  # mutate(weightedProbColMention = ProbColMention * PropClicks_prior_sim) %>%
  # group_by(condition, targetType, compType) %>%
  # mutate(norm = sum(weightedProbColMention)) %>%
  # ungroup() %>%
  # mutate(predProportion = (ProbColMention * PropClicks_prior_sim) / norm) %>%
  # mutate(prioredContext = case_when(
  #   (targetType == "banana" | targetType == "carrot" | targetType == "egg") & (compType == "banana" | compType == "carrot" | compType == "egg") ~ "both_priored",
  #   (targetType == "banana" | targetType == "carrot" | targetType == "egg") ~ "target_prior",
  #   (compType == "banana" | compType == "carrot" | compType == "egg") ~ "comp_prior",
  #   TRUE ~ "not_priored"
  #   )) %>% 
  # no prior simulation
  mutate(weightedProbColMention = ProbColMention * PropClicks_prior) %>%
  group_by(condition, targetType, compType, prior) %>%
  mutate(norm = sum(weightedProbColMention)) %>%
  ungroup() %>%
  mutate(predProportion = (ProbColMention * PropClicks_prior) / norm) %>%
  #
  select(condition, predProportion, PropClicks_prior, targetType, compType, intended_target, prior)

df_rsa_prior_aggrTarget = df_rsa_prior_aggr %>% 
  filter(intended_target == "target") %>% 
  select(condition, predProportion, PropClicks_prior, targetType, compType, prior)

```

# Plots

## Correlation

### Flat prior -- COGSCI plot

```{r}

source(here("models","02_prodInfRSA","helpers.r"))

df_cor_flatprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks=mean(PropClicks),
            prop_CI_low_diff=ci.low(PropClicks),
            prop_CI_high_diff=ci.high(PropClicks),
            meanProb=mean(Probability),
            prob_CI_low_diff=ci.low(Probability),
            prob_CI_high_diff=ci.high(Probability)) %>% 
  ungroup() %>% 
  mutate(prob_CI_low = meanProb-prob_CI_low_diff) %>% 
  mutate(prob_CI_high = meanProb+prob_CI_high_diff) %>% 
  mutate(prop_CI_low = meanPropClicks-prop_CI_low_diff) %>% 
  mutate(prop_CI_high = meanPropClicks+prop_CI_high_diff) %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

glimpse(df_cor_flatprior)

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("writing","2020_CogSci","paper","graphs","corr-modelflat-bycondition.pdf"), width = 5.5, height = 3)

```

```{r}

df_cor_flatprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup() %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

# df_cor_flatprior

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

# df_cor_flatprior %>% 
#   select(condition,meanProb,meanPropClicks)

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("corr-modelflat-bycondition.pdf"), width = 6, height = 3.5)

```

### Flat prior + pos

```{r}

df_cor_flatprior = df_afteradjpos_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition, pos) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup() %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

# df_cor_flatprior

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=pos)) +
  geom_smooth(method="lm") +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  # scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("writing", "2020_CogSci", "paper", "graphs", "corr-modelflat-bycondition.pdf"), width = 6, height = 3.5)

```

### Flat prior + prev click & pos

```{r}

df_cor_prevposflat = df_prevpos_propTarget %>% 
  left_join(df_rsa_flatpriorTarget)  %>% 
  filter(prior=="weird") %>% 
  group_by(condition, pos, prevClickedType) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# view(df_cor_prevposflat)

df_cor_prevposflat %>% 
  # filter(n_compr > 4) %>% 
  filter(pos == "equal") %>%
  # filter(prevClickedType == "other") %>%
ggplot(., aes(x=meanProb, y=meanPropClicks, color=condition)) +
  facet_wrap(~prevClickedType, nrow=3) +
  # facet_wrap(~pos) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

df_corcalc = df_cor_prevposflat %>% 
  filter(pos == "equal") %>%
  filter(prevClickedType == "other")

cor(df_corcalc$meanProb,df_corcalc$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```

### Simple prior

```{r}

df_cor_simpprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget) %>% 
  filter(prior=="normal") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# df_cor_simpprior

ggplot(df_cor_simpprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_simpprior$meanProb,df_cor_simpprior$meanPropClicks)

df_cor_simpprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget) %>% 
  filter(prior=="weird") %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# df_cor_simpprior

ggplot(df_cor_simpprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_simpprior$meanProb,df_cor_simpprior$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```


### Prior + prev click & pos

```{r}

df_cor_prevposprior = df_prevpos_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget)  %>% 
  group_by(condition, pos, prevClickedType) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

view(df_cor_prevposprior)

df_cor_prevposprior %>% 
  # filter(n_compr > 4) %>% 
  filter(pos == "equal") %>%
  # filter(prevClickedType == "other") %>%
ggplot(., aes(x=meanProb, y=meanPropClicks, color=condition)) +
  facet_wrap(~prevClickedType, nrow=3) +
  # facet_wrap(~pos) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

df_corcalc = df_cor_prevposprior %>% 
  filter(pos == "equal") %>%
  filter(prevClickedType == "other")

cor(df_corcalc$meanProb,df_corcalc$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```

## Empirical vs. condition

### Flat prior

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prior=="normal") %>% 
  # filter(str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  # theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no_preadj_model.pdf"), width = 8, height = 5)
# ggsave(here("preadj_model.pdf"), width = 8, height = 5)

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prior=="weird") %>% 
  # filter(str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  # theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no_preadj_model.pdf"), width = 8, height = 5)
# ggsave(here("preadj_model.pdf"), width = 8, height = 5)

```

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no-preadj-flatprior-contrast.pdf"), width = 8, height = 3)
ggsave(here("preadj-flatprior-contrast.pdf"), width = 8, height = 3)

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(!str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no-preadj-flatprior-nocontrast.pdf"), width = 8, height = 3)
ggsave(here("preadj-flatprior-nocontrast.pdf"), width = 8, height = 3)
```

##### CUNY poster plot

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  filter(Measure == "Model predictions")

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=intended_target
                # alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.6),
               width = 0.6) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.6),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_fill_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("modelpred-contrast.pdf"), width = 8, height = 3)

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(!str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=intended_target
                # alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.6),
               width = 0.6) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.6),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_fill_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("modelpred-nocontrast.pdf"), width = 8, height = 3)
```

### Flat prior + prev click & pos

```{r}

df_full = df_prevpostClick %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior)  %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  filter(pos == "equal") %>%
  filter(prevClickedType == "other") %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("writing", "2020_CogSci", "paper", "graphs", "modelflat-bycondition-targetprevClick.pdf"), width = 8, height = 6)

```

### Simple prior

```{r shiny data creation}
df_model_pred_flatprior = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_prior_aggr, by=(c("condition", "targetType", "compType", "intended_target", "prior"))) %>% 
  gather(Measure, Value, PropClicks, predProportion) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  filter(Measure == "Model predictions") %>% 
  rename(clicked = "Value") %>% 
  rename(obj_in_display_diff = "intended_target") %>% 
  select(obj_in_display_diff, clicked, condition, prior)

write_csv(df_model_pred_flatprior, "model_prior.csv")
```

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_prior_aggr, by=(c("condition", "targetType", "compType", "intended_target", "prior"))) %>% 
  gather(Measure, Value, PropClicks, predProportion) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prior=="normal") %>% 
  # filter(prioredContext == "both_priored") %>% 
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("priormanipulation_itemprior_both.pdf"), width = 8, height = 6)
```

### Prior + prev click & pos

```{r}

df_full = df_prevpostClick %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior)  %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  # filter(pos == "equal") %>%
  filter(prevClickedType == "target") %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("writing", "2020_CogSci", "paper", "graphs", "modelflat-bycondition-targetprevClick.pdf"), width = 8, height = 6)

```






## Very Old Plots

```{r}
df_comprehension = read_csv(here("models","02_prodInfRSA","data","emp_comprehension_data.csv")) %>% 
  # select(condition, timeStep_selec, clickedType, obj_in_display, clicked, target, comp) %>% 
  separate(target, c(NA, "targetType"), sep="_") %>% 
  separate(comp, c(NA, "compType"), sep="_")

# df_prevClick = df_comprehension %>% 
#   filter(timeStep_selec == "selectedItem_prior") %>% 
#   group_by(condition, obj_in_display, targetType, compType) %>% 
#   summarize(PropClicks_prior = mean(clicked),
#             n = n()) %>% 
#   ungroup()

df_prevClick = df_comprehension %>% 
  select(timeStep_selec, condition, clickedType, clicked, targetType, compType, 
        pos1, pos2, pos3, pos4, anon_worker_id, trial_number) %>% 
  filter(timeStep_selec == "selectedItem_prior") %>%
  filter(clicked == 1) %>%
  rename(prevClickedType = "clickedType") %>% 
  select(-timeStep_selec, -clicked)

df_targetClick = df_comprehension %>%
  select(timeStep_selec, condition, clickedType, obj_in_display, clicked, targetType, compType,
        pos1, pos2, pos3, pos4, anon_worker_id, trial_number) %>%
  filter(timeStep_selec == "selectedItem1") %>%
  # filter(clicked == 1) %>%
  select(-timeStep_selec)

df_all = df_prevClick %>% 
  left_join(df_targetClick, by=c("condition", "targetType", "compType", 
        "pos1", "pos2", "pos3", "pos4", "anon_worker_id", "trial_number")) %>% 
  mutate_at(vars(prevClickedType), funs(ifelse(. == "contrast/distractor" | . == "distractor", "other", .))) %>% 
  mutate(pos_target = ifelse(pos1 == "target" | pos2 == "target", T, F)) %>%
  mutate(pos_comp = ifelse(pos1 == "comp" | pos2 == "comp", T, F)) %>%
  mutate(pos = case_when(
    (pos_target & pos_comp) | (!pos_target & !pos_comp) ~ "equal",
    pos_target ~ "target_pref",
    TRUE ~ "comp_pref"
  )) %>% 
  filter(clickedType == "target" | clickedType == "comp") %>% 
  filter(obj_in_display == "target" | obj_in_display == "comp") %>% 
  mutate_at(vars(obj_in_display), funs(factor(., levels=c("target", "comp")))) %>% 
  mutate_at(vars(prevClickedType), funs(factor(., levels=c("target", "comp", "other"))))

ggplot(df_all, aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)

df_all %>% 
  filter(pos == "equal") %>% 
ggplot(., aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)

df_all %>% 
  filter(pos == "target_pref") %>% 
ggplot(., aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)

df_all %>% 
  filter(pos == "comp_pref") %>% 
ggplot(., aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)
```

```{r}
# glimpse(df_all)
# glimpse(df_rsa_flatprior)

df_emp = df_all %>% 
  group_by(condition, targetType, compType, prevClickedType, pos, obj_in_display) %>% 
  summarize(emp_mean = mean(clicked)) %>% 
  ungroup() %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, targetType, compType, prevClickedType, pos, emp_mean)

df_cor = df_emp %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType")))

df_cor %>% 
  ggplot(., aes(x=Probability, y=emp_mean, color=pos)) +
    facet_wrap(~prevClickedType) +
    geom_abline(intercept = 0, slope = 1) +
    geom_point(alpha=0.5) +
    geom_smooth(method="lm")

df_cor = df_emp %>% 
  left_join(df_rsa_prior, by=(c("condition","targetType","compType")))

df_cor %>% 
  ggplot(., aes(x=Probability, y=emp_mean, color=pos)) +
    facet_wrap(~prevClickedType) +
    geom_abline(intercept = 0, slope = 1) +
    geom_point(alpha=0.5) +
    geom_smooth(method="lm")
```





