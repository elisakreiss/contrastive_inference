---
title: "RSA simple"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import data and libraries

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
library(cowplot)
# library(plyr)
library(tidyverse)
library(here)
# library(boot)

theme_set(theme_cowplot())

target_color = "#d55e00" # red
comp_color = "#009e74"

model_color = "#cc79a7" # purple
emp_color = "#0071b2" # blue
  
```

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

# imports comprehension data (already only critical trials)
df_comprehension_import = read_csv(here("models","02_prodInfRSA","data","emp_comprehension_data.csv"))
# df_comprehension_import = read_csv(here("models","02_prodInfRSA","data","emp_compr_noprior_data.csv"))

df_comprehension = df_comprehension_import %>% 
  select(condition, timeStep_selec, clickedType, obj_in_display, clicked, target, comp, pos1, pos2, pos3, pos4, anon_worker_id, trial_number) %>% 
  # exclude trials with wrong selection after adj
  filter(!(timeStep_selec == "selectedItem1" & !(clickedType == "target" | clickedType == "comp"))) %>%
  # filter(clickedType == "target" | clickedType == "comp") %>% 
  # filter(obj_in_display == "target" | obj_in_display == "comp") %>% 
  separate(target, c(NA, "targetType"), sep="_") %>% 
  separate(comp, c(NA, "compType"), sep="_") %>% 
  # encode position of target and competitor
  mutate(pos_target = ifelse(pos1 == "target" | pos2 == "target", T, F)) %>%
  mutate(pos_comp = ifelse(pos1 == "comp" | pos2 == "comp", T, F)) %>%
  mutate(pos = case_when(
    (pos_target & pos_comp) | (!pos_target & !pos_comp) ~ "equal",
    pos_target ~ "target_pref",
    TRUE ~ "comp_pref"
  )) %>% 
  select(-pos1, -pos2, -pos3, -pos4, -pos_target, -pos_comp)

# imports production data
df_production_import = read_csv(here("models","02_prodInfRSA","data","emp_production_data.csv")) 

df_production = df_production_import %>% 
  # only has typeOnly and colorType utterances
  filter(UtteranceCat == "typeOnly" | UtteranceCat == "colorType") %>% 
  # only has the critical trials where the speaker refers to target or comp
  filter(intended_target == "target" | intended_target == "firstDistractor") %>% 
  # exclude trials where the listener clicked the wrong object (unsuccessful utterance)
  mutate(wrong_selection = ifelse(intended_target == "target", !str_detect(selected_image, target_item), !str_detect(selected_image, comp_item))) %>% 
  filter(!wrong_selection) %>% 
  # because we filtered for typeOnly and colorType utterances, 
  # ColorMention is only 1 for colorType utterances
  select(intended_target, condition, targetType, compType, ColorMention) %>% 
  # rename firstDistractor to "comp"
  mutate_at(vars(intended_target), funs(ifelse(.=="firstDistractor", "comp", .)))
```


# Comprehension data

```{r}

df_afteradj_selections = df_comprehension %>% 
  # after adj trials only
  filter(timeStep_selec == "selectedItem1") 
  # filter out incorrect selections
  # filter(clickedType == "target" | clickedType == "comp") %>% 
  # TODO: NECESSARY? target and comp remain the only relevant objects
  # filter(obj_in_display == "target" | obj_in_display == "comp")

# target and comp prob add up to 1, since they were the only options
df_afteradj_prop = df_afteradj_selections %>% 
  group_by(condition, obj_in_display, targetType, compType) %>% 
  summarize(PropClicks = mean(clicked)) %>% 
  ungroup() %>% 
  select(condition, PropClicks, targetType, compType, obj_in_display)

df_afteradj_propTarget = df_afteradj_prop %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, PropClicks, targetType, compType)

```


## Comprehension data with pos

```{r}

df_afteradjpos_prop = df_afteradj_selections %>% 
  group_by(condition, obj_in_display, targetType, compType, pos) %>% 
  summarize(PropClicks = mean(clicked)) %>% 
  ungroup() %>% 
  select(condition, PropClicks, targetType, compType, obj_in_display, pos)

df_afteradjpos_propTarget = df_afteradjpos_prop %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, PropClicks, targetType, compType, pos)

```

## Comprehension data with prev click and pos

```{r}

# extract prior from comprehension data
df_beforeadj = df_comprehension %>% 
  # only clicks before adjective
  filter(timeStep_selec == "selectedItem_prior")

# prevClick empirical comprehension data
df_prevClick = df_beforeadj %>% 
  rename(prevClickedType = "clickedType") %>% 
  select(prevClickedType, obj_in_display, anon_worker_id, trial_number) %>% 
  mutate_at(vars(prevClickedType), funs(ifelse(. == "contrast/distractor" | . == "distractor", "other", .)))

# full empirical comprehension data
df_prevpostClick = df_afteradj_selections %>%
  select(-timeStep_selec) %>% 
  left_join(df_prevClick) %>% 
  select(condition, clickedType, obj_in_display, clicked, targetType, compType, prevClickedType, pos) %>% 
  group_by(condition, obj_in_display, targetType, compType, prevClickedType, pos) %>%
  # group_by(condition, obj_in_display, targetType, prevClickedType, pos) %>% 
  summarize(PropClicks = mean(clicked),
            n_compr = n()) %>% 
  ungroup() %>% 
  select(condition, PropClicks, targetType, compType, obj_in_display, prevClickedType, pos, n_compr)
  # select(condition, PropClicks, targetType, obj_in_display, prevClickedType, pos, n_compr)

df_prevpos_propTarget = df_prevpostClick %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, PropClicks, targetType, compType, prevClickedType, pos, n_compr)
  # select(condition, PropClicks, targetType, prevClickedType, pos, n_compr)
```



# Production data

```{r}

# deal with data that needs to be duplicated for no contrast contexts
df_prodcompetitor = df_production %>% 
  filter(str_detect(condition, "n")) %>% 
  mutate(intended_target = "comp") %>% 
  mutate_at(vars(condition), funs(case_when(
    .=="atn" ~ "tan",
    .=="tan" ~ "atn",
    TRUE ~ .
  ))) %>% 
  mutate(targetType_rev = compType) %>% 
  mutate(compType_rev = targetType) %>% 
  select(-targetType, -compType) %>% 
  rename(targetType = "targetType_rev",
         compType = "compType_rev")

df_prod_full = df_production %>% 
  # include duplicated comp data
  bind_rows(df_prodcompetitor)

# target and comp probability do NOT add up to 1 (not normalized yet)
df_prodprob = df_prod_full %>% 
  group_by(condition, intended_target, targetType, compType) %>% 
  summarize(ProbColMention = mean(ColorMention)) %>% 
  ungroup()

```


# RSA: flat prior data

```{r}

df_rsa_flatprior = df_prodprob %>% 
  group_by(condition, targetType, compType) %>% 
  mutate(norm = sum(ProbColMention)) %>% 
  ungroup() %>% 
  mutate(Probability = ProbColMention / norm) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  select(condition, Probability, targetType, compType, intended_target)

df_rsa_flatpriorTarget = df_rsa_flatprior %>% 
  filter(intended_target == "target") %>% 
  select(condition, Probability, targetType, compType)

```

```{r shiny data creation}
df_model_pred_flatprior = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  filter(Measure == "Model predictions") %>% 
  rename(clicked = "Value") %>% 
  rename(obj_in_display_diff = "intended_target") %>% 
  mutate(prior = "flat") %>% 
  select(obj_in_display_diff, clicked, condition, prior)

write_csv(df_model_pred_flatprior, "model_flatprior.csv")
```


# RSA: inf prior data


## Simple prior

```{r eval=FALSE, include=FALSE}
  
# aggregated prior over all objects in the display
df_prior_aggr = df_beforeadj %>% 
  group_by(condition, obj_in_display, targetType, compType) %>% 
  summarize(PropClicks_prior = mean(clicked)) %>% 
  ungroup() %>% 
  rename(intended_target = "obj_in_display")

# RSA model predictions with aggregated prior
# since the selection probability after adj is 0, contrast and distractor(s) disappear
df_rsa_prior_aggr = df_prodprob %>% 
  left_join(df_prior_aggr) %>% 
  # # typicality prior simulation
  # mutate(PropClicks_prior_sim = case_when(
  #   str_detect(condition, "ta") & intended_target == "target" ~ PropClicks_prior*0.5,
  #   str_detect(condition, "ta") & intended_target == "comp" ~ PropClicks_prior*2,
  #   str_detect(condition, "at") & intended_target == "target" ~ PropClicks_prior*2,
  #   str_detect(condition, "at") & intended_target == "comp" ~ PropClicks_prior*0.5,
  #   TRUE ~ PropClicks_prior
  # )) %>%
  # mutate_at(vars(PropClicks_prior_sim), funs(ifelse(.>1, 1, .))) %>%
  # mutate(weightedProbColMention = ProbColMention * PropClicks_prior_sim) %>%
  # group_by(condition, targetType, compType) %>%
  # mutate(norm = sum(weightedProbColMention)) %>%
  # ungroup() %>%
  # mutate(predProportion = (ProbColMention * PropClicks_prior_sim) / norm) %>%
  #
  # # item prior simulation
  # mutate(PropClicks_prior_sim = case_when(
  #   (targetType == "banana" | targetType == "carrot" | targetType == "egg") & intended_target == "target" ~ PropClicks_prior*2,
  #   (compType == "banana" | compType == "carrot" | compType == "egg") & intended_target == "target" ~ PropClicks_prior*0.5,
  #   TRUE ~ PropClicks_prior
  # )) %>%
  # mutate_at(vars(PropClicks_prior_sim), funs(ifelse(.>1, 1, .))) %>%
  # mutate(weightedProbColMention = ProbColMention * PropClicks_prior_sim) %>%
  # group_by(condition, targetType, compType) %>%
  # mutate(norm = sum(weightedProbColMention)) %>%
  # ungroup() %>%
  # mutate(predProportion = (ProbColMention * PropClicks_prior_sim) / norm) %>%
  # mutate(prioredContext = case_when(
  #   (targetType == "banana" | targetType == "carrot" | targetType == "egg") & (compType == "banana" | compType == "carrot" | compType == "egg") ~ "both_priored",
  #   (targetType == "banana" | targetType == "carrot" | targetType == "egg") ~ "target_prior",
  #   (compType == "banana" | compType == "carrot" | compType == "egg") ~ "comp_prior",
  #   TRUE ~ "not_priored"
  #   )) %>% 
  # no prior simulation
  mutate(weightedProbColMention = ProbColMention * PropClicks_prior) %>%
  group_by(condition, targetType, compType) %>%
  mutate(norm = sum(weightedProbColMention)) %>%
  ungroup() %>%
  mutate(predProportion = (ProbColMention * PropClicks_prior) / norm) %>%
  #
  select(condition, predProportion, PropClicks_prior, targetType, compType, intended_target, prioredContext)

df_rsa_prior_aggrTarget = df_rsa_prior_aggr %>% 
  filter(intended_target == "target") %>% 
  select(condition, predProportion, PropClicks_prior, targetType, compType)

```


# Plots

## Correlation

### Flat prior -- COGSCI plot

```{r}

source(here("models","02_prodInfRSA","helpers.r"))

df_cor_flatprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks=mean(PropClicks),
            prop_CI_low_diff=ci.low(PropClicks),
            prop_CI_high_diff=ci.high(PropClicks),
            meanProb=mean(Probability),
            prob_CI_low_diff=ci.low(Probability),
            prob_CI_high_diff=ci.high(Probability)) %>% 
  ungroup() %>% 
  mutate(prob_CI_low = meanProb-prob_CI_low_diff) %>% 
  mutate(prob_CI_high = meanProb+prob_CI_high_diff) %>% 
  mutate(prop_CI_low = meanPropClicks-prop_CI_low_diff) %>% 
  mutate(prop_CI_high = meanPropClicks+prop_CI_high_diff) %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

glimpse(df_cor_flatprior)

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

ggsave(here("writing","2020_CogSci","paper","graphs","corr-modelflat-bycondition.pdf"), width = 5.5, height = 3)

```

```{r}

df_cor_flatprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup() %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

# df_cor_flatprior

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

# df_cor_flatprior %>% 
#   select(condition,meanProb,meanPropClicks)

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("corr-modelflat-bycondition.pdf"), width = 6, height = 3.5)

```

### Flat prior + pos

```{r}

df_cor_flatprior = df_afteradjpos_propTarget %>% 
  left_join(df_rsa_flatpriorTarget) %>% 
  group_by(condition, pos) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup() %>% 
  mutate(contrast = ifelse(str_detect(condition, "p"), "contrast present", "contrast absent")) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan"))))

# df_cor_flatprior

ggplot(df_cor_flatprior, aes(x=meanProb, y=meanPropClicks, color=pos)) +
  geom_smooth(method="lm") +
  geom_abline(intercept = 0, slope = 1) +
  geom_vline(xintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point(size = 3.5) +
  # xlim(0,1) +
  # ylim(0,1) +
  coord_cartesian(xlim = c(0.2,0.9), ylim = c(0.2,0.9)) +
  # scale_color_manual(values=c("#edc951", "#c9df8a", "#eb6841", "#77ab59", "#cc2a36", "#36802d", "#cc2a87", "#234d20")) +
  # scale_color_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  xlab("Model prediction") +
  ylab("Empirical proportion of\ntarget selections")

cor(df_cor_flatprior$meanProb,df_cor_flatprior$meanPropClicks)

# df_rsa_flatpriorTarget %>%
  # select(condition, Probability, targetType, compType) %>% 
  # write_csv(., here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

# ggsave(here("writing", "2020_CogSci", "paper", "graphs", "corr-modelflat-bycondition.pdf"), width = 6, height = 3.5)

```

### Flat prior + prev click & pos

```{r}

df_cor_prevposflat = df_prevpos_propTarget %>% 
  left_join(df_rsa_flatpriorTarget)  %>% 
  group_by(condition, pos, prevClickedType) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(Probability),
            se_prob=sd(Probability)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# view(df_cor_prevposflat)

df_cor_prevposflat %>% 
  # filter(n_compr > 4) %>% 
  filter(pos == "equal") %>%
  # filter(prevClickedType == "other") %>%
ggplot(., aes(x=meanProb, y=meanPropClicks, color=condition)) +
  facet_wrap(~prevClickedType, nrow=3) +
  # facet_wrap(~pos) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

df_corcalc = df_cor_prevposflat %>% 
  filter(pos == "equal") %>%
  filter(prevClickedType == "other")

cor(df_corcalc$meanProb,df_corcalc$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```

### Simple prior

```{r}

df_cor_simpprior = df_afteradj_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget) %>% 
  group_by(condition) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

# df_cor_simpprior

ggplot(df_cor_simpprior, aes(x=meanProb, y=meanPropClicks, color=condition)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

cor(df_cor_simpprior$meanProb,df_cor_simpprior$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```


### Prior + prev click & pos

```{r}

df_cor_prevposprior = df_prevpos_propTarget %>% 
  left_join(df_rsa_prior_aggrTarget)  %>% 
  group_by(condition, pos, prevClickedType) %>% 
  summarize(meanPropClicks = mean(PropClicks),
            se_prop=sd(PropClicks)/sqrt(n()),
            prop_CI_low=meanPropClicks-1.96*se_prop,
            prop_CI_high=meanPropClicks+1.96*se_prop,
            meanProb = mean(predProportion),
            se_prob=sd(predProportion)/sqrt(n()),
            prob_CI_low=meanProb-1.96*se_prob,
            prob_CI_high=meanProb+1.96*se_prob) %>% 
  ungroup()

view(df_cor_prevposprior)

df_cor_prevposprior %>% 
  # filter(n_compr > 4) %>% 
  filter(pos == "equal") %>%
  # filter(prevClickedType == "other") %>%
ggplot(., aes(x=meanProb, y=meanPropClicks, color=condition)) +
  facet_wrap(~prevClickedType, nrow=3) +
  # facet_wrap(~pos) +
  geom_errorbar(aes(ymin = prop_CI_low, ymax = prop_CI_high)) + 
  geom_errorbarh(aes(xmin = prob_CI_low, xmax = prob_CI_high)) +
  geom_abline(intercept = 0, slope = 1) +
  geom_point() +
  xlim(0,1) +
  ylim(0,1)

df_corcalc = df_cor_prevposprior %>% 
  filter(pos == "equal") %>%
  filter(prevClickedType == "other")

cor(df_corcalc$meanProb,df_corcalc$meanPropClicks)

# df_rsa_flatprior = df_cor %>% 
#   select(condition, Probability, targetType, compType)
# write_csv(df_rsa_flatprior, here("analyses", "03_comprehension", "02_main", "0102_summary", "df_rsa_flatprior.csv"))

```

## Empirical vs. condition

### Flat prior

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20", "#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no_preadj_model.pdf"), width = 8, height = 5)
# ggsave(here("preadj_model.pdf"), width = 8, height = 5)

```

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no-preadj-flatprior-contrast.pdf"), width = 8, height = 3)
ggsave(here("preadj-flatprior-contrast.pdf"), width = 8, height = 3)

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(!str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition,
                alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  # scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("no-preadj-flatprior-nocontrast.pdf"), width = 8, height = 3)
ggsave(here("preadj-flatprior-nocontrast.pdf"), width = 8, height = 3)
```

##### COGSCI talk & CUNY poster plot

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp") %>% 
  filter(Measure == "Model predictions")

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition
                # fill=intended_target
                # alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.6),
               width = 0.6) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.6),
               size = .3,
               width = 0.3) +
  # geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  # scale_fill_manual(values=c(target_color, comp_color)) +
  # scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("modelpred-contrast.pdf"), width = 8, height = 2.95)

df_full %>%
  # mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(!str_detect(condition, "p")) %>%
  mutate_at(vars(condition), funs(case_when(
    str_detect(.,"at") ~ "atypical target\ntypical competitor",
    str_detect(.,"ta") ~ "typical target\natypical competitor",
    str_detect(.,"aa") ~ "atypical target\natypical competitor",
    str_detect(.,"tt") ~ "typical target\ntypical competitor",
    TRUE ~ "FIRE!"
  ))) %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=condition
                # fill=intended_target
                # alpha=Measure
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.6),
               width = 0.6) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.6),
               size = .3,
               width = 0.3) +
  # geom_hline(yintercept = 0.5, linetype="dashed", color = "lightgrey") +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  # scale_fill_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c("#edc951", "#eb6841", "#cc2a36", "#cc2a87")) +
  # scale_fill_manual(values=c("#c9df8a", "#77ab59", "#36802d", "#234d20")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.text.x = element_text(size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("modelpred-nocontrast.pdf"), width = 8, height = 2.95)
```

### Flat prior + prev click & pos

```{r}

df_full = df_prevpostClick %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior)  %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  filter(pos == "equal") %>%
  filter(prevClickedType == "other") %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

# ggsave(here("writing", "2020_CogSci", "paper", "graphs", "modelflat-bycondition-targetprevClick.pdf"), width = 8, height = 6)

```

### Simple prior

```{r}

df_full = df_afteradj_prop %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_prior_aggr, by=(c("condition","targetType","compType", "intended_target"))) %>% 
  gather(Measure, Value, PropClicks, predProportion) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  filter(prioredContext == "both_priored") %>% 
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("priormanipulation_itemprior_both.pdf"), width = 8, height = 6)
```

### Prior + prev click & pos

```{r}

df_full = df_prevpostClick %>% 
  rename(intended_target = "obj_in_display") %>% 
  left_join(df_rsa_flatprior)  %>% 
  gather(Measure, Value, PropClicks, Probability) %>% 
  mutate_at(vars(Measure), funs(ifelse(.=="PropClicks", "Empirical data", "Model predictions"))) %>% 
  filter(intended_target == "target" | intended_target == "comp")

df_full %>%
  # filter(pos == "equal") %>%
  filter(prevClickedType == "target") %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  # filter(!str_detect(condition, "p")) %>%
  # mutate_at(vars(condition), funs(case_when(
  #   str_detect(.,"at") ~ "atypical target\ntypical competitor",
  #   str_detect(.,"ta") ~ "typical target\natypical competitor",
  #   str_detect(.,"aa") ~ "atypical target\natypical competitor",
  #   str_detect(.,"tt") ~ "typical target\ntypical competitor",
  #   TRUE ~ "FIRE!"
  # ))) %>% 
  # mutate_at(vars(condition), funs(factor(., levels=c("atypical target\ntypical competitor", "typical target\ntypical competitor", "atypical target\natypical competitor", "typical target\natypical competitor")))) %>%
  mutate_at(vars(intended_target), funs(factor(., levels=c("target", "comp")))) %>%
  ggplot(., aes(x=intended_target, 
                y=Value, 
                fill=Measure
                # color=intended_target
                )) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               position = position_dodge(width = 0.8),
               width = 0.8) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_color_manual(values=c(target_color, comp_color)) +
  scale_fill_manual(values=c(model_color, emp_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  coord_cartesian(ylim = c(0,0.9)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1,size=14)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of (predicted) selections")

ggsave(here("writing", "2020_CogSci", "paper", "graphs", "modelflat-bycondition-targetprevClick.pdf"), width = 8, height = 6)

```









# Old Plots

```{r}
df_comprehension = read_csv(here("models","02_prodInfRSA","data","emp_comprehension_data.csv")) %>% 
  # select(condition, timeStep_selec, clickedType, obj_in_display, clicked, target, comp) %>% 
  separate(target, c(NA, "targetType"), sep="_") %>% 
  separate(comp, c(NA, "compType"), sep="_")

# df_prevClick = df_comprehension %>% 
#   filter(timeStep_selec == "selectedItem_prior") %>% 
#   group_by(condition, obj_in_display, targetType, compType) %>% 
#   summarize(PropClicks_prior = mean(clicked),
#             n = n()) %>% 
#   ungroup()

df_prevClick = df_comprehension %>% 
  select(timeStep_selec, condition, clickedType, clicked, targetType, compType, 
        pos1, pos2, pos3, pos4, anon_worker_id, trial_number) %>% 
  filter(timeStep_selec == "selectedItem_prior") %>%
  filter(clicked == 1) %>%
  rename(prevClickedType = "clickedType") %>% 
  select(-timeStep_selec, -clicked)

df_targetClick = df_comprehension %>%
  select(timeStep_selec, condition, clickedType, obj_in_display, clicked, targetType, compType,
        pos1, pos2, pos3, pos4, anon_worker_id, trial_number) %>%
  filter(timeStep_selec == "selectedItem1") %>%
  # filter(clicked == 1) %>%
  select(-timeStep_selec)

df_all = df_prevClick %>% 
  left_join(df_targetClick, by=c("condition", "targetType", "compType", 
        "pos1", "pos2", "pos3", "pos4", "anon_worker_id", "trial_number")) %>% 
  mutate_at(vars(prevClickedType), funs(ifelse(. == "contrast/distractor" | . == "distractor", "other", .))) %>% 
  mutate(pos_target = ifelse(pos1 == "target" | pos2 == "target", T, F)) %>%
  mutate(pos_comp = ifelse(pos1 == "comp" | pos2 == "comp", T, F)) %>%
  mutate(pos = case_when(
    (pos_target & pos_comp) | (!pos_target & !pos_comp) ~ "equal",
    pos_target ~ "target_pref",
    TRUE ~ "comp_pref"
  )) %>% 
  filter(clickedType == "target" | clickedType == "comp") %>% 
  filter(obj_in_display == "target" | obj_in_display == "comp") %>% 
  mutate_at(vars(obj_in_display), funs(factor(., levels=c("target", "comp")))) %>% 
  mutate_at(vars(prevClickedType), funs(factor(., levels=c("target", "comp", "other"))))

ggplot(df_all, aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)

df_all %>% 
  filter(pos == "equal") %>% 
ggplot(., aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)

df_all %>% 
  filter(pos == "target_pref") %>% 
ggplot(., aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)

df_all %>% 
  filter(pos == "comp_pref") %>% 
ggplot(., aes(x=obj_in_display, y=clicked, group=condition, color=condition)) +
  facet_wrap(~prevClickedType) +
  # geom_point(alpha=0.3) +
  stat_summary(fun.y = "mean",
               geom = "point",
               size = 3) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3)
```

```{r}
# glimpse(df_all)
# glimpse(df_rsa_flatprior)

df_emp = df_all %>% 
  group_by(condition, targetType, compType, prevClickedType, pos, obj_in_display) %>% 
  summarize(emp_mean = mean(clicked)) %>% 
  ungroup() %>% 
  filter(obj_in_display == "target") %>% 
  select(condition, targetType, compType, prevClickedType, pos, emp_mean)

df_cor = df_emp %>% 
  left_join(df_rsa_flatprior, by=(c("condition","targetType","compType")))

df_cor %>% 
  ggplot(., aes(x=Probability, y=emp_mean, color=pos)) +
    facet_wrap(~prevClickedType) +
    geom_abline(intercept = 0, slope = 1) +
    geom_point(alpha=0.5) +
    geom_smooth(method="lm")

df_cor = df_emp %>% 
  left_join(df_rsa_prior, by=(c("condition","targetType","compType")))

df_cor %>% 
  ggplot(., aes(x=Probability, y=emp_mean, color=pos)) +
    facet_wrap(~prevClickedType) +
    geom_abline(intercept = 0, slope = 1) +
    geom_point(alpha=0.5) +
    geom_smooth(method="lm")
```





