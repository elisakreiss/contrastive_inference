---
title: "CI: IDT analysis"
# output: html_document
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r data import, include=FALSE}
library(tidyverse)
library(here)

df = read_csv(here("analyses","full_analysis","data","comprehension.csv")) %>% 
  mutate_at(vars(obj_in_display_diff),
            funs(factor(., levels=c("target", "comp", "contrast",
                                    "distractor1", "distractor", "distractor2")))) %>% 
  mutate(category = case_when(
    preadj_selection & timeStep_selec == "selectedItem_prior" ~ "preadj_selections",
    preadj_selection & timeStep_selec == "selectedItem1" ~ "wpreadj_critical",
    !preadj_selection & timeStep_selec == "selectedItem1" ~ "nopreadj_critical",
    TRUE ~ "FIRE"
  )) %>%
  mutate(condition_long = case_when(
    condition == "atp" ~ "contrast present\natypical target\ntypical competitor",
    condition == "ttp" ~ "contrast present\ntypical target\ntypical competitor",
    condition == "aap" ~ "contrast present\natypical target\natypical competitor",
    condition == "tap" ~ "contrast present\ntypical target\natypical competitor",
    condition == "atn" ~ "contrast absent\natypical target\ntypical competitor",
    condition == "ttn" ~ "contrast absent\ntypical target\ntypical competitor",
    condition == "aan" ~ "contrast absent\natypical target\natypical competitor",
    condition == "tan" ~ "contrast absent\ntypical target\natypical competitor",
    TRUE ~ "FIRE"
  )) %>% 
  mutate_at(vars(condition_long),
            funs(factor(., levels=c(
              "contrast present\natypical target\ntypical competitor",
              "contrast present\ntypical target\ntypical competitor",
              "contrast present\natypical target\natypical competitor",
              "contrast present\ntypical target\natypical competitor",
              "contrast absent\natypical target\ntypical competitor",
              "contrast absent\ntypical target\ntypical competitor",
              "contrast absent\natypical target\natypical competitor",
              "contrast absent\ntypical target\natypical competitor"))))

```

```{r color palette, include=FALSE}
# this palette is color blind friendly

target_color = "#d55e00" # red
comp_color = "#009e74" # blueish green
contrast_color = "#e69d00" # orange
distractor_2_color = "#f0e442" # yellow; always present
distractor_1_color = "#f0e442" # yellow; encoded as contrast

typical_color = "#cc79a7" # purple
atypical_color = "#0071b2" # blue

pos1_color = "#fef0d9"
pos2_color = "#fdcc8a"
pos3_color = "#fc8d59"
pos4_color = "#d7301f"

```

# Write data for RSA

```{r eval=FALSE, include=FALSE}
df %>%
  filter(trial_type == "critical",
         timeStep_selec != "selectedItem2"
         # !mult_selec
         ) %>% 
  select(prior, preadj_selection, condition, condition_long, category, clicked, 
         obj_in_display_diff, obj_in_display, timeStep_selec, clickedType, target, comp) %>% 
  write_csv(here("models", "03_prodInfRSA_prior", "data", "emp_comprehension_data.csv"))

# df_worker_breakdown = df %>% 
#   filter(!preadj_selection) %>% 
#   distinct(anon_worker_id, prior)
# table(df_worker_breakdown$prior)
```


# Main plots

```{r}
df_plot = df %>%
  filter(trial_type == "critical",
         timeStep_selec != "selectedItem2"
         # !mult_selec
         ) %>% 
  mutate(obj_typicality = case_when(
    obj_in_display == "target" ~ target_typ_bin,
    obj_in_display == "comp" ~ comp_typ_bin,
    obj_in_display == "contrast/distractor" ~ contrast_typ_bin,
    obj_in_display == "distractor" ~ distractor_typ_bin,
    TRUE ~ "FIRE")) %>% 
  mutate(target_pos = case_when(
    pos1 == "target" ~ "pos1",
    pos2 == "target" ~ "pos2",
    pos3 == "target" ~ "pos3",
    pos4 == "target" ~ "pos4",
    TRUE ~ "FIRE"
  )) %>% 
  mutate(comp_pos = case_when(
    pos1 == "comp" ~ "pos1",
    pos2 == "comp" ~ "pos2",
    pos3 == "comp" ~ "pos3",
    pos4 == "comp" ~ "pos4",
    TRUE ~ "FIRE"
  )) %>% 
  select(prior, preadj_selection, condition, condition_long, category, clicked, 
         obj_in_display_diff, obj_in_display, timeStep_selec, clickedType,
         obj_typicality, target_pos, comp_pos, context_id)
```


## No and with prior manipulation

```{r no prior}

cond_byprior = function(prior_cond) {
df_plot %>% 
  filter(prior == prior_cond) %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                            y=clicked, 
                            fill=obj_in_display_diff, 
                            alpha=category)) +
  facet_wrap(~condition_long, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.85)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")}

cond_byprior("none")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_allselections.png"), height=7, width=10)

cond_byprior("normal")

# ggsave(here("analyses","full_analysis","graphs","comprehension_normalprior_allselections.png"), height=7, width=10)

cond_byprior("weird")

# ggsave(here("analyses","full_analysis","graphs","comprehension_weirdprior_allselections.png"), height=7, width=10)
```

```{r paper}

df_plot = df_plot %>% 
  mutate_at(vars(condition), 
            funs(factor(., levels=c("ttn", "aan", "tan", "atn", 
                                    "ttp", "aap", "tap", "atp")))) %>% 
  mutate(obj_typ = case_when(
    obj_in_display_diff == "target" ~ str_sub(condition,1,1),
    obj_in_display_diff == "comp" ~ str_sub(condition,2,2),
    T ~ "other"
  ))

df_plot %>% 
  filter(prior == "none",
         category == "preadj_selections") %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_typ)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.85)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_allselections.png"), height=7, width=10)

df_plot %>% 
  filter(prior == "none",
         category == "nopreadj_critical",
         obj_in_display_diff == "target" | obj_in_display_diff == "comp") %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_typ,
                alpha=category)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.9),
               color="black",
               size=0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.4)) +
  scale_fill_manual(values=c("#4c4c4c", "#cccccc")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","comprehension_nopreadjresult_typcol.png"), height=5, width=6)

df_plot %>% 
  filter(prior == "none",
         condition == "ttn" | condition == "ttp" | condition == "tap",
         category == "nopreadj_critical",
         obj_in_display_diff == "target" | obj_in_display_diff == "comp") %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_typ)) +
  facet_wrap(~condition, scales = "free_x", nrow=1) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.9),
               color="black",
               size=0.2) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"),
                                    size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.4)) +
  scale_fill_manual(values=c("#4c4c4c", "#cccccc")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  theme(
        panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black")) +
  xlab("Item") +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","comprehension_nopreadjresult_condzoom.png"), height=2.5, width=5.5)

```


## Contrastive inference

```{r contr inference}

cond_byprior = function(prior_cond) {
df_plot %>% 
  filter(obj_in_display == "target") %>% 
  mutate(contrast_present = ifelse(str_detect(condition,"p"), "present", "absent")) %>% 
  # mutate_at(vars(clicked), funs(ifelse(contrast_present == "absent" & clicked == 1, -1, .))) %>% 
  mutate(typ_cond = str_replace_all(condition_long,"contrast present\n|contrast absent\n","")) %>% 
  mutate_at(vars(typ_cond), funs(fct_relevel(., c("atypical target\ntypical competitor", 
                                                  "typical target\ntypical competitor", 
                                                  "atypical target\natypical competitor")))) %>% 
  # mutate_at(vars(obj_in_display), funs(fct_relevel(., c("target", 
  #                                                       "comp", 
  #                                                       "contrast/distractor")))) %>% 
  mutate_at(vars(preadj_selection), funs(fct_relevel(ifelse(., "after preadj selections", "no preadj selections"),
                                                     c("no preadj selections")))) %>% 
  filter(prior == prior_cond,
         timeStep_selec == "selectedItem1") %>% 
  ggplot(., aes(x=typ_cond, 
                y=clicked, 
                fill=contrast_present)) +
  facet_wrap(~preadj_selection, scales = "free_x", nrow=1) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.4)) +
  scale_fill_manual(values=c(pos2_color, pos3_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.85)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Condition") +
  ylab("Proportion of target selections")}

cond_byprior("none")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_contrastiveinference.png"), height=4.5, width=9.5)

```

## Prior manipulation

```{r no prior}

df_plot %>% 
  filter(!preadj_selection,
         prior != "none") %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_in_display_diff, 
                alpha=prior)) +
  facet_wrap(~condition_long, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.85)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

# ggsave(here("analyses","full_analysis","graphs","comprehension_weirdvsnormalprior.png"), height=7, width=10)

df_plot %>% 
  filter(!preadj_selection) %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_in_display_diff, 
                alpha=prior)) +
  facet_wrap(~condition_long, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.85)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

```

```{r}
# inspection
# df %>% 
#   filter(!preadj_selection,
#          trial_type == "critical",
#          timeStep_selec != "selectedItem2",
#          prior == "normal",
#          clicked == 1,
#          condition == "atn") %>%
#   select(clickedType, target, comp, contrast, distractor, anon_worker_id) %>% 
#   view()

df_plot %>% 
  filter(!preadj_selection,
         obj_in_display_diff == "target") %>% 
  #        condition %in% c("atp", "atn", "tap", "tan")) %>% 
  mutate_at(vars(condition), funs(fct_relevel(., "ttn", "aan", "tan", "atn", "ttp", "aap", "tap", "atp"))) %>% 
  mutate(contrast_present = str_detect(condition, "p")) %>% 
  ggplot(., aes(x=condition, 
                y=clicked, 
                fill=prior)) +
  # facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.7),
               size = .2,
               color = "black") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  # scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c("#7F93B5", "#93b57f", "#667e58")) +
  # scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  xlab("Condition") +
  ylab("Proportion of\ntarget selections")
  # geom_hline(yintercept=0.5, linetype="dashed", color="grey")

# ggsave(here("analyses","full_analysis","graphs","comprprior_nopreadjresult.png"), height=5, width=6.5, bg = "transparent")

# paper plot

# TODO: clickedType == target or comp
df_plot %>% 
  filter(!preadj_selection,
         obj_in_display_diff == "target") %>% 
  #        condition %in% c("atp", "atn", "tap", "tan")) %>% 
  mutate_at(vars(condition), funs(fct_relevel(., "ttn", "aan", "tan", "atn", "ttp", "aap", "tap", "atp"))) %>% 
  mutate(contrast_present = str_detect(condition, "p")) %>% 
  ggplot(., aes(x=condition, 
                y=clicked, 
                fill=prior)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.6,
               position = position_dodge(width = 0.7),
               size = .2,
               color = "black") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.2) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  # scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c("#7F93B5", "#93b57f", "#667e58")) +
  # scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,1)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  xlab("Condition") +
  ylab("Proportion of\ntarget selections")
  # geom_hline(yintercept=0.5, linetype="dashed", color="grey")

# ggsave(here("analyses","full_analysis","graphs","comprprior_nopreadjresult.png"), height=5, width=6.5, bg = "transparent")

paper_prior_data = df_plot %>% 
  filter(!preadj_selection,
         obj_in_display_diff == "target")

# write_csv(paper_prior_data, here("analyses", "full_analysis", "data", "paper_prior_data.csv"))
```


## Pre-adj Prior manipulation

```{r}
df_plot %>% 
  filter(preadj_selection,
         timeStep_selec == "selectedItem_prior") %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_in_display_diff, 
                alpha=prior)) +
  facet_wrap(~prior, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

df_plot %>% 
  filter(preadj_selection,
         timeStep_selec == "selectedItem_prior") %>% 
  ggplot(., aes(x=obj_typicality, 
                y=clicked, 
                fill=prior)) +
  facet_wrap(~prior, scales = "free_x", nrow=1) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.7,
               color = "black",
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c("#808080", "#009988", "#ee7733")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  # coord_cartesian(ylim = c(0,0.75)) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  xlab("Item") +
  ylab("Proportion of selections")

ggsave("preadj_distr.png", height=3.5, width=6.5)
```

```{r}
df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  ggplot(., aes(x=obj_typicality, 
                y=clicked, 
                alpha=prior)) +
  facet_wrap(~prior, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
  # mutate_at(var(obj_typicality), funs(ifelse(.=="typical", 0, 1))) %>%
  ggplot(., aes(x=prior, 
                y=bin_obj_typ, 
                alpha=prior)) +
  # facet_wrap(~target_pos, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of target being atypical")

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "comp") %>% 
  mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
  # mutate_at(var(obj_typicality), funs(ifelse(.=="typical", 0, 1))) %>%
  ggplot(., aes(x=prior, 
                y=bin_obj_typ, 
                alpha=prior)) +
  # facet_wrap(~target_pos, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of comp being atypical")

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
  # mutate_at(var(obj_typicality), funs(ifelse(.=="typical", 0, 1))) %>%
  ggplot(., aes(x=prior, 
                y=clicked, 
                alpha=prior)) +
  facet_wrap(~target_pos, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of target being selected")

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
  # mutate_at(var(obj_typicality), funs(ifelse(.=="typical", 0, 1))) %>%
  ggplot(., aes(x=prior, 
                y=clicked, 
                alpha=prior)) +
  facet_wrap(~context_id, scales = "free_x", nrow=7) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of target being selected")


df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1") %>% 
  mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
  # mutate_at(var(obj_typicality), funs(ifelse(.=="typical", 0, 1))) %>%
  ggplot(., aes(x=prior, 
                y=clicked, 
                alpha=prior)) +
  facet_wrap(~obj_in_display, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of target selections")

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display=="target") %>% 
  mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
  # mutate_at(var(obj_typicality), funs(ifelse(.=="typical", 0, 1))) %>%
  ggplot(., aes(x=prior, 
                y=clicked, 
                alpha=prior)) +
  facet_wrap(~condition, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of target selections")

df_overview = df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display=="target")

table(df_overview$condition, df_overview$prior)

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display=="target") %>% 
  group_by(prior, condition) %>% 
  summarize(target_sel = mean(clicked)) %>% 
  ungroup() %>% 
  group_by(prior) %>% 
  summarize(mean_target_sel = mean(target_sel)) %>% 
  ungroup()
```


```{r no prior}

df_plot %>% 
  filter(preadj_selection,
         timeStep_selec == "selectedItem_prior") %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked, 
                fill=obj_in_display_diff, 
                alpha=prior)) +
  facet_wrap(~condition_long, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.9,
               position = position_dodge(width = 0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.9),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  coord_cartesian(ylim = c(0,0.75)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")


```

## Individual condition

```{r tan analysis}

condition_id = "aan"

df_plot %>% 
  filter(preadj_selection,
         timeStep_selec == "selectedItem_prior",
         condition == condition_id) %>% 
  # mutate(merged_distractors = case_when(
  #   obj_in_display_diff == "distractor1" ~ "distractor",
  #   obj_in_display_diff == "distractor2" ~ "distractor",
  #   obj_in_display_diff == "target" ~ "target",
  #   obj_in_display_diff == "comp" ~ "comp",
  #   TRUE ~ "FIRE"
  # )) %>% 
  # mutate_at(vars(merged_distractors), funs(fct_relevel(., c("target", "comp", "distractor")))) %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=clicked)) +
  facet_wrap(~prior, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.7,
               position = position_dodge(width = 0.7),
               fill = "#929292",
               color = "black") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

# ggsave("tan_condition_prior.png", height=4, width=4.5, bg="transparent")

df_plot %>% 
  filter(preadj_selection,
         timeStep_selec == "selectedItem_prior",
         condition == condition_id) %>% 
  mutate(bin_typ = ifelse(obj_typicality == "atypical", 1, 0)) %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                y=bin_typ)) +
  facet_wrap(~prior, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.7,
               position = position_dodge(width = 0.7),
               fill = "#929292",
               color = "black") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  scale_alpha_manual(values=c(1, 0.6, 0.4)) +
  scale_fill_manual(values=c(target_color, comp_color,
                               contrast_color, distractor_1_color,
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Typicality")

df_plot %>% 
  filter(!preadj_selection,
         timeStep_selec == "selectedItem1",
         condition == condition_id) %>% 
  mutate(merged_distractors = case_when(
    obj_in_display_diff == "distractor1" ~ "distractor",
    obj_in_display_diff == "distractor2" ~ "distractor",
    obj_in_display_diff == "target" ~ "target",
    obj_in_display_diff == "comp" ~ "comp",
    TRUE ~ "FIRE"
  )) %>% 
  mutate_at(vars(merged_distractors), funs(fct_relevel(., c("target", "comp", "distractor")))) %>% 
  ggplot(., aes(x=merged_distractors, 
                y=clicked)) +
  facet_wrap(~prior, scales = "free_x", nrow=2) +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.7,
               position = position_dodge(width = 0.7),
               fill = "#7F93B5",
                color="black") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.7),
               size = .3,
               width = 0.3) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
        ) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
  theme(panel.border = element_rect(colour = "black", fill=NA),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "black"),
        plot.background = element_rect(fill = "transparent",colour = NA)) +
  coord_cartesian(ylim = c(0,1)) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(axis.title = element_text(size=16)) +
  xlab("Item") +
  ylab("Proportion of selections")

# ggsave("tan_condition_empcriticallistener.png", height=4, width=5, bg="transparent")
# 
# df_pos = df_plot %>% 
#   filter(!preadj_selection,
#          timeStep_selec == "selectedItem1") %>% 
#   mutate(pos_adv = case_when(
#     (((target_pos == "pos1") | (target_pos == "pos2")) & ((comp_pos == "pos1") | (comp_pos == "pos2"))) | ((target_pos == "pos3") | (target_pos == "pos4")) & ((comp_pos == "pos3") | (comp_pos == "pos4")) ~ "even",
#     ((target_pos == "pos1") | (target_pos == "pos2")) & ((comp_pos == "pos3") | (comp_pos == "pos4")) ~ "target_advantage",
#     ((target_pos == "pos3") | (target_pos == "pos4")) & ((comp_pos == "pos1") | (comp_pos == "pos2")) ~ "comp_advantage",
#     TRUE ~ "FIRE"
#   ))
# 
# df_pos %>% 
#   filter(obj_in_display == "target") %>% 
#   ggplot(., aes(x=pos_adv)) +
#   facet_wrap(~prior, scales = "free_x", nrow=2) +
#   geom_bar(stat="count")
# 
# df_plot %>% 
#   filter(!preadj_selection,
#          timeStep_selec == "selectedItem1",
#          obj_in_display == "target") %>% 
#   mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
#   ggplot(., aes(x=target_pos, 
#                 # y=bin_obj_typ, 
#                 alpha=prior)) +
#   facet_wrap(~prior, scales = "free_x", nrow=2) +
#   geom_bar(stat="count") +
#   theme(legend.position = "top") +
#   theme(strip.background = element_rect(color="black", 
#                                         fill="white", 
#                                         size=1.5,
#                                         linetype="solid"),
#         strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
#         ) +
#   scale_alpha_manual(values=c(1, 0.6, 0.4)) +
#   scale_fill_manual(values=c(target_color, comp_color,
#                                contrast_color, distractor_1_color,
#                                distractor_2_color, distractor_2_color)) +
#   scale_x_discrete(labels=c("comp"="competitor")) +
#   theme(strip.background = element_rect(color="black", 
#                                         fill="white", 
#                                         size=1,
#                                         linetype="solid"),
#         strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
#   # coord_cartesian(ylim = c(0,0.75)) +
#   theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
#   theme(axis.title = element_text(size=16))
# 
# df_plot %>% 
#   filter(!preadj_selection,
#          timeStep_selec == "selectedItem1",
#          obj_in_display == "comp") %>% 
#   mutate(bin_obj_typ = ifelse(obj_typicality=="typical", 0, 1)) %>% 
#   ggplot(., aes(x=comp_pos, 
#                 # y=clicked,
#                 fill=prior)) +
#   facet_wrap(~prior, scales = "free_x", nrow=2) +
#   geom_bar(stat="count") +
#   # stat_summary(fun = "mean",
#   #              geom = "bar",
#   #              width = 0.9,
#   #              position = position_dodge(width = 0.9)) +
#   # stat_summary(fun.data = "mean_cl_boot",
#   #              geom = "errorbar",
#   #              color = "black",
#   #              position = position_dodge(width = 0.9),
#   #              size = .3,
#   #              width = 0.3) +
#   theme(legend.position = "top") +
#   theme(strip.background = element_rect(color="black", 
#                                         fill="white", 
#                                         size=1.5,
#                                         linetype="solid"),
#         strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)
#         ) +
#   # scale_alpha_manual(values=c(1, 0.6, 0.4)) +
#   # scale_fill_manual(values=c(target_color, comp_color,
#                                # contrast_color, distractor_1_color,
#                                # distractor_2_color, distractor_2_color)) +
#   # scale_x_discrete(labels=c("comp"="competitor")) +
#   theme(strip.background = element_rect(color="black", 
#                                         fill="white", 
#                                         size=1,
#                                         linetype="solid"),
#         strip.text.x = element_text(margin = margin(4,0,4,0, "pt"), size=14)) +
#   # coord_cartesian(ylim = c(0,0.75)) +
#   theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
#   theme(axis.title = element_text(size=16))


```


# Statistical analysis

```{r stat analysis load libraries, eval=FALSE, include=FALSE}
library(brms)
options(mc.cores = parallel::detectCores())

df_model =  df %>% 
  filter(trial_type == "critical",
         # !mult_selec,
         clicked == 1,
         timeStep_selec == "selectedItem_prior" | timeStep_selec == "selectedItem1") %>% 
  # select columns relevant for main trials
  select(prior,preadj_selection,target,comp,timeStep_selec,clickedType,
         anon_worker_id,trial_number,condition,contrast_present,
         target_typ_bin, comp_typ_bin, utterance) %>% 
  spread(timeStep_selec, clickedType) %>% 
  # filter out erroneous selections
  filter(selectedItem1 == "target" | selectedItem1 == "comp") %>% 
  mutate(click_to_target = ifelse(selectedItem1 == "target", 1, 0)) %>%
  mutate(prev_click = ifelse(selectedItem_prior == "target", 1, 0)) %>%
  # typicalities
  mutate_at(vars(target_typ_bin, comp_typ_bin), funs(ifelse(. == "typical", 0, 1))) %>%
  # item types
  separate(target, c(NA, "targetType"), sep="_", remove = FALSE) %>%
  separate(comp, c(NA, "compType"), sep="_", remove = FALSE) %>% 
  mutate(tar_comp = str_c(targetType, compType, sep="_"))

# debug prev_click issues
# df_debug = df %>% 
#   filter(trial_type == "critical",
#          clicked == 1,
#          preadj_selection,
#          timeStep_selec == "selectedItem_prior" | timeStep_selec == "selectedItem1",
#          prior == "normal") %>% 
#   # select columns relevant for main trials
#   select(prior,preadj_selection,target,comp,timeStep_selec,clickedType,
#          anon_worker_id,trial_number,condition,contrast_present,
#          target_typ_bin, comp_typ_bin, utterance) %>% 
#   spread(timeStep_selec, clickedType) %>% 
#   filter(selectedItem1 == "target" | selectedItem1 == "comp")
```


#### No prior

```{r}

# No prior, preadj selections
# contrast (+), comp_typ (-), prev_click (+)
# uncentered: contrast (+), ttyp (+), prev_click (+), contrast:ttyp (-), contrast:ctyp:ttyp (+)
df_m_noprior_preadjsel = df_model %>%
  filter(prior == "none",
         preadj_selection) %>%
  mutate(c_prev_click = prev_click - mean(prev_click)) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present")
# COGSCI PAPER
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin + c_prev_click + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin|target) + (1+c_contrast*c_target_typ_bin|comp)
# f = click_to_target ~ contrast*target_typ_bin*comp_typ_bin + prev_click + (1+contrast*target_typ_bin|anon_worker_id) + (1+contrast*comp_typ_bin|target) + (1+contrast*target_typ_bin|comp)

model_noprior_preadjsel = brm(
  formula = f,
  data = df_m_noprior_preadjsel,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_noprior_preadjsel)

#  No prior, no preadj selections
# contrast (+), target_typ (+), comp_typ (-)
# dummy-coded: contrast (+), ttyp (+), ctyp (-)
df_m_noprior_nopreadjsel = df_model %>%
  filter(prior == "none",
         !preadj_selection) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present")
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin|target) + (1+c_contrast*c_target_typ_bin|comp)
# f = click_to_target ~ c_contrast+c_target_typ_bin+c_comp_typ_bin + (1+c_contrast+c_target_typ_bin|anon_worker_id) + (1+c_contrast+c_comp_typ_bin|target) + (1+c_contrast+c_target_typ_bin|comp)

model_noprior_nopreadjsel = brm(
  formula = f,
  data = df_m_noprior_nopreadjsel,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_noprior_nopreadjsel)


# Simple effects

df_m_noprior_nopreadjsel_simple_contrast = df_model %>%
  filter(prior == "none",
         !preadj_selection) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present") %>% 
  filter(contrast)
f = click_to_target ~ target_typ_bin*comp_typ_bin + (1+target_typ_bin|anon_worker_id) + (1+comp_typ_bin|target) + (1+target_typ_bin|comp)

model_noprior_nopreadjsel_simple_contrast = brm(
  formula = f,
  data = df_m_noprior_nopreadjsel_simple_contrast,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_noprior_nopreadjsel_simple_contrast)


df_m_noprior_nopreadjsel_simple_nocontrast = df_model %>%
  filter(prior == "none",
         !preadj_selection) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present") %>% 
  filter(!contrast)
f = click_to_target ~ target_typ_bin*comp_typ_bin + (1+target_typ_bin|anon_worker_id) + (1+comp_typ_bin|target) + (1+target_typ_bin|comp)

model_noprior_nopreadjsel_simple_nocontrast = brm(
  formula = f,
  data = df_m_noprior_nopreadjsel_simple_nocontrast,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_noprior_nopreadjsel_simple_nocontrast)

# Frequentist analysis
library(lme4)
library(lmerTest)

# f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin|target) + (1+c_contrast*c_target_typ_bin|comp) # doesn't converge
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin + (1+c_contrast*c_target_typ_bin|anon_worker_id) # singular fit but still converges
m = lmer(f, df_m_noprior_nopreadjsel)
# main effect of intercept, contrast, target_typicality, comp_typicality
summary(m)

# simple effects analysis
m = lmer(formula=click_to_target ~ target_typ_bin*comp_typ_bin + (1+target_typ_bin|anon_worker_id), 
         data=filter(df_m_noprior_nopreadjsel, contrast))
# main effect of intercept, target_typicality, comp_typicality
summary(m)
# m = lmer(formula=click_to_target ~ target_typ_bin*comp_typ_bin + (1+target_typ_bin|anon_worker_id), 
#          data=filter(df_m_noprior_nopreadjsel, !contrast)) # doesn't converge
m = lmer(formula=click_to_target ~ target_typ_bin*comp_typ_bin + (1|anon_worker_id), 
         data=filter(df_m_noprior_nopreadjsel, !contrast))
# main effect of intercept, target_typicality, comp_typicality
summary(m)

```

#### Prior

```{r}
# Prior, preadj selections

# got rid of prior interaction in random effects for worker

# comp_typ (-), prev_click (+), target_typ:prior (+), comp_typ:prior (-)
# ?uncentered: prev_click (+), ttyp:prior (+), ctyp:prior (-)
df_m_prior_preadjsel = df_model %>%
  filter(prior != "none",
         preadj_selection) %>%
  mutate(prior_bin = ifelse(prior == "normal", 0, 1)) %>% 
  mutate(c_prior = prior_bin - mean(prior_bin)) %>% 
  mutate(c_prev_click = prev_click - mean(prev_click)) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present")
# preregistered
# Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable. Running the chains for more iterations may help. See http://mc-stan.org/misc/warnings.html#bulk-ess
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + c_prev_click + (1+c_contrast*c_target_typ_bin*c_prior|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp)
# main effects: comp_typ, prev_click, target_typ:prior, comp_typ:prior
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + c_prev_click + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp)
# f = click_to_target ~ contrast*target_typ_bin*comp_typ_bin*prior + prev_click + (1+contrast*target_typ_bin|anon_worker_id) + (1+contrast*comp_typ_bin*prior|target) + (1+contrast*target_typ_bin*prior|comp)

model_prior_preadjsel = brm(
  formula = f,
  data = df_m_prior_preadjsel,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_prior_preadjsel)

# f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + c_prev_click + (1+c_contrast*c_target_typ_bin*c_prior|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp) # doesn't run
# f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + c_prev_click + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp) # doesn't run
# Correlation matrix not shown by default, as p = 17 > 12.
# Use print(x, correlation=TRUE)  or
#     vcov(x)        if you need it
# main effects: intercept, comp_typ, prev_click, target_typ:prior, comp_typ:prior
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + c_prev_click + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1|target) + (1|comp) # doesn't run
m = lmer(f, df_m_prior_preadjsel)
summary(m)


# Prior, no preadj selections

# prior (-), target_typ:prior (+), comp_typ:prior (-)
# ? uncentered: targettyp:weirdprior (+), contrastTRUE:comptyp:priorweird (-)
df_m_prior_nopreadjsel = df_model %>%
  filter(prior != "none",
         !preadj_selection) %>%
  mutate(prior_bin = ifelse(prior == "normal", 0, 1)) %>% 
  mutate(c_prior = prior_bin - mean(prior_bin)) %>% 
  mutate(c_prev_click = prev_click - mean(prev_click)) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present")

df_worker_breakdown = df_m_prior_nopreadjsel %>% 
  distinct(anon_worker_id, prior)
table(df_worker_breakdown$prior)

library(effsize)

df_normal = df_m_prior_nopreadjsel %>% 
  filter(c_prior < 0)
df_weird = df_m_prior_nopreadjsel %>% 
  filter(c_prior > 0)
cohen.d(df_normal$click_to_target, df_weird$click_to_target)

# preregistered
# Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable. Running the chains for more iterations may help. See http://mc-stan.org/misc/warnings.html#bulk-ess
# effects: prior, comp_typ:prior, target_typ:prior
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + (1+c_contrast*c_target_typ_bin*c_prior|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp)
# same effects
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp)
# f = click_to_target ~ contrast*target_typ_bin*comp_typ_bin*prior + (1+contrast*target_typ_bin|anon_worker_id) + (1+contrast*comp_typ_bin*prior|target) + (1+contrast*target_typ_bin*prior|comp)


model_prior_nopreadjsel = brm(
  formula = f,
  data = df_m_prior_nopreadjsel,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_prior_nopreadjsel)

# f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + (1+c_contrast*c_target_typ_bin*c_prior|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp) # doesn't converge
# f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*c_prior|target) + (1+c_contrast*c_target_typ_bin*c_prior|comp) # doesn't run
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*c_prior + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1|target) + (1|comp)
m = lmer(f, df_m_prior_nopreadjsel)
summary(m)

```

#### Full model

```{r}
# no preadj selections

# contrast (+), targ_typ (+), comp_typ (-), prior_coding (-), target_typ:comp_typ (-), target_typ:prior (+), comp_typ:prior (-)
df_m_nopreadjsel = df_model %>%
  filter(!preadj_selection) %>%
  mutate(prior_coding = factor(prior,
                                levels = c("normal", "none", "weird"),
                                labels = c(-1, 0, 1)),
         prior_coding = prior_coding %>% as.character() %>% as.numeric()) %>% 
  # mutate(prior_dummy = ifelse(prior == "none", 0, ifelse(prior == "normal", 1, 2))) %>% 
  # mutate_at(vars(prior_dummy), funs(as.factor(.))) %>% 
  # mutate(c_prior = prior_bin - mean(prior_bin)) %>% 
  mutate(c_prev_click = prev_click - mean(prev_click)) %>%
  mutate(c_target_typ_bin = target_typ_bin-mean(target_typ_bin)) %>%
  mutate(c_comp_typ_bin = comp_typ_bin-mean(comp_typ_bin)) %>%
  mutate(c_contrast = contrast_present-mean(contrast_present)) %>% 
  rename(contrast = "contrast_present")
f = click_to_target ~ c_contrast*c_target_typ_bin*c_comp_typ_bin*prior_coding + (1+c_contrast*c_target_typ_bin|anon_worker_id) + (1+c_contrast*c_comp_typ_bin*prior_coding|target) + (1+c_contrast*c_target_typ_bin*prior_coding|comp)


model_nopreadjsel = brm(
  formula = f,
  data = df_m_nopreadjsel,
  seed = 1702,
  family = 'bernoulli',
  iter = 4000
)

summary(model_nopreadjsel)


```


#### TODO: RSA

```{r}

# TODO

df_rsa_flatprior = read_csv(here("analyses","03_comprehension","02_main","0102_summary","df_rsa_flatprior.csv"))

df_model_rsa =  df %>% 
  # select main trials
  filter(trial_type == "critical") %>% 
  # select columns relevant for main trials
  select(target,comp,contrast,distractor,selectedItem_prior,selectedItem1,
         anon_worker_id,trial_number,condition,pos1,pos2,pos3,pos4) %>% 
  # if there were multiple selections (which are separated by commas),
  # select the last one
  mutate(lastSelectedItem_prior = sapply(str_split(selectedItem_prior,","),tail,1)) %>% 
  mutate(lastSelectedItem_adj = sapply(str_split(selectedItem1,","),tail,1)) %>% 
  # encode the clicked type of the object
  mutate(clickedType_prior = case_when(
    lastSelectedItem_prior == target ~ "target",
    lastSelectedItem_prior == comp ~ "comp",
    TRUE ~ "other"
  )) %>% 
  mutate(clickedType_adj = case_when(
    lastSelectedItem_adj == target ~ "target",
    lastSelectedItem_adj == comp ~ "comp",
    TRUE ~ "other"
  )) %>% 
  filter(clickedType_adj=="target" | clickedType_adj=="comp") %>% 
  mutate(click_to_target = ifelse(clickedType_adj == "target", 1, 0)) %>%
  mutate(prev_click = ifelse(clickedType_prior == "target", 1, 0)) %>%
  mutate(c_prev_click = prev_click-mean(prev_click)) %>%
  # item types
  separate(target, c(NA, "targetType"), sep="_", remove = FALSE) %>%
  separate(comp, c(NA, "compType"), sep="_", remove = FALSE) %>% 
  mutate(tar_comp = str_c(targetType, compType, sep="_")) %>% 
  # position constellation
  mutate(pos_target = ifelse(pos1 == "target" | pos2 == "target", T, F)) %>%
  mutate(pos_comp = ifelse(pos1 == "comp" | pos2 == "comp", T, F)) %>%
  mutate(pos = case_when(
    (pos_target & pos_comp) | (!pos_target & !pos_comp) ~ "equal",
    pos_target ~ "target_pref",
    TRUE ~ "comp_pref"
  )) %>% 
  select(clickedType_prior, pos, condition, targetType, compType, click_to_target, anon_worker_id) %>% 
  left_join(df_rsa_flatprior) %>% 
  rename(RSA_pred = "Probability")


f_rsa = click_to_target ~ RSA_pred+clickedType_prior*pos + (1+RSA_pred|anon_worker_id)

# significant Intercept, RSA_pred, clickedType_priorother, clickedType_priortarget
f_rsa2 = click_to_target ~ RSA_pred+clickedType_prior + (1+RSA_pred+clickedType_prior|anon_worker_id)

# divergent
f_rsa2 = click_to_target ~ RSA_pred+clickedType_prior*pos + (1+RSA_pred|anon_worker_id)

# no convergence
f_rsa2 = click_to_target ~ RSA_pred*clickedType_prior*pos + (1+RSA_pred|anon_worker_id)

# significant Intercept, RSA_pred, clickedType_priorother, clickedType_priortarget
f_rsa2 = click_to_target ~ RSA_pred*clickedType_prior + (1+RSA_pred*clickedType_prior|anon_worker_id)

# divergent
f_rsa2 = click_to_target ~ RSA_pred*clickedType_prior*pos + (1+RSA_pred*clickedType_prior|anon_worker_id)

# significant Intercept, RSA_pred, clickedType_priortarget
f_rsa2 = click_to_target ~ RSA_pred*clickedType_prior*pos + (1+RSA_pred*clickedType_prior*pos|anon_worker_id)

# divergent
f_rsa2 = click_to_target ~ RSA_pred+clickedType_prior+pos + (1+RSA_pred|anon_worker_id)

# significant Intercept, RSA_pred, clickedType_priorother, clickedType_priortarget
f_rsa2 = click_to_target ~ RSA_pred*clickedType_prior + (1+RSA_pred+clickedType_prior|anon_worker_id)

# significant Intercept and RSA_pred
# COGSCI
f_rsa3 = click_to_target ~ RSA_pred + (1+RSA_pred|anon_worker_id)
# f_rsa3 = click_to_target ~ RSA_pred + (1+RSA_pred|anon_worker_id)

# divergent
f_rsanew = click_to_target ~ RSA_pred + clickedType_prior + (1+RSA_pred|anon_worker_id)

# glmer()

model_rsanew = brm(
  formula = f_rsa3,
  data = df_model_rsa,
  seed = 1702,
  family = 'bernoulli'
  # save_all_pars = TRUE
)

summary(model_rsanew)

bayes_factor(model_rsa, model_rsanew)

  

```























# Supplementary analyses

TODO: differentiate out the different prior/preadj conditions; trial_type critical; no mult_selec

## Pre-adjective selections

To investigate the priors that participants have for particular contexts, we look at the filler as well as the critical trials.

```{r prepare prior df, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

df_preadj_wfillers = df %>%
  filter(preadj_selection,
         timeStep_selec == "selectedItem_prior",
         prior == "none") %>% 
  mutate_at(vars(obj_in_display), funs(fct_relevel(., "target", "comp", "contrast/distractor")))

```


#### Intended-target bias

If a contrast object is present, is it more likely that the target/contrast are selected? 

Overall, there does not seem to be a bias in favor of the two objects that are in contrast. However, we see there is learning curve where in the second half of the experiment (here in darker colors/higher alpha), target selection becomes more likely when a contrast is present.

```{r prior target bias, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
df_preadj_wf_contrast = df_preadj_wfillers %>%
  mutate_at(vars(contrast_present), 
            funs(ifelse(contrast_present, "contrast", "no contrast")))

# If a contrast is NOT present, do the prior distributions change between the first and 
# second half of the experiment?
ggplot(df_preadj_wf_contrast, aes(x=obj_in_display, 
                                 y=clicked, 
                                 fill=obj_in_display, 
                                 alpha=trial_half)) +
  # facet_wrap(vars(contrast_present), scales = "free_x") +
  stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.7,
               position = position_dodge(width=0.65)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3,
               position = position_dodge(width=0.65)) +
  theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(5,0,5,0, "pt"))
        ) +
  scale_alpha_manual(values=c(1, 0.5)) +
  scale_fill_manual(values=c(target_color, comp_color, 
                               contrast_color, distractor_1_color, 
                               distractor_2_color, distractor_2_color)) +
  guides(fill = FALSE,
         alpha = guide_legend(title="Trial half")) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  xlab("Item function") +
  ylab("Proportion of clicks")
  # ggtitle("Prior distribution by trial half")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_preadj_inttargetbias.png"), height=3, width=5)

```


#### Position bias

Is there one position on the grid that is preferred? Yes, in fact the two upper grid cells. Further analysis suggests that the bias is not learned throughout the experiment, because the target was equally likely to occur in the bottom two grid cells (and in fact did) and the pattern remains unchanged over trial halves. This could be connected to the fact that the utterance stood above the grid. 


```{r prior position bias, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
df_preadj_wfillers_pos = df_preadj_wfillers %>%
  mutate_at(vars(pos1,pos2,pos3,pos4), funs(ifelse(. == "contrast", "contrast/distractor", .))) %>% 
  mutate(clicked_obj_pos = case_when(
    obj_in_display == pos1 ~ "upper left",
    obj_in_display == pos2 ~ "upper right",
    obj_in_display == pos3 ~ "lower left",
    obj_in_display == pos4 ~ "lower right",
    TRUE ~ "other"
  ))

ggplot(df_preadj_wfillers_pos, aes(x=reorder(clicked_obj_pos, -clicked), y=clicked, fill=clicked_obj_pos)) +
  stat_summary(fun.y = "mean", 
               geom = "bar") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(legend.position = "none",
        axis.ticks.x = element_blank()) +
  scale_fill_manual(values=c(pos1_color, pos2_color, 
                             pos3_color, pos4_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  xlab("Grid position") +
  ylab("Proportion of clicks")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_preadj_positionbias.png"), height=3, width=5)
```

#### By-item bias

Overall, there was not a big item preference that is different from chance. The only item that seems slightly preferred is the green swan, which is the only atypical animate object.

```{r byitem prior, echo=FALSE}

typ_data = read_csv(here::here("data","01_norming","02_main","typicality_data.csv")) %>% 
  filter(!(col_type=="green_corn" | col_type=="white_carrot" | type=="snowman")) %>% 
  mutate(bin_typ=ifelse(typicality>50,"typical","atypical"))

# total occurrences range between 623 (white pumpkin) and 825 (red strawberry)
df_byitemprior = df_preadj_wfillers %>%
  filter(clicked == 1) %>%  
  select(clickedType, target, comp, contrast, distractor) %>% 
  gather(obj_fct, item, -clickedType) %>% 
  mutate_at(vars(clickedType), funs(str_replace_all(., "contrast/distractor", "contrast"))) %>% 
  mutate(clicked = ifelse(clickedType == obj_fct, 1, 0)) %>% 
  left_join(typ_data, by=c("item"="col_type"))

ggplot(df_byitemprior, aes(x=reorder(item, clicked), y=clicked, fill=typicality)) +
  stat_summary(fun = "mean", 
               geom = "bar") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3) +
  theme(axis.text.x = element_text(angle=40, hjust=1)) +
  geom_hline(yintercept=1/4, linetype="dashed", color="grey") +
  xlab("Item") +
  ylab("Proportion of clicks") +
  labs(fill="Typicality")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_preadj_itembias.png"), height=3, width=5)

# # This plot shows the difference between items of the same typicality and color. 
# # They are generally very close, with the exception of the green carrot and green swan. 
ggplot(df_byitemprior, aes(x=reorder(item, clicked), y=clicked, fill=color)) +
  stat_summary(fun = "mean",
               geom = "bar",
               color = "black") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3) +
  facet_wrap(vars(bin_typ), scales = "free_x") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  scale_fill_identity()

```

## After adjective selections

From now on, we will only look at the critical trials.

```{r prepare after adj selection df, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

df_adj = df %>%
  filter(timeStep_selec == "selectedItem1",
         trial_type == "critical")

df_preadj_vs_adj = df %>% 
  filter(timeStep_selec == "selectedItem_prior" | timeStep_selec == "selectedItem1",
         trial_type == "critical")

```


#### Overall patterns per condition

We see a target boost/competitor reduction though in all conditions. However, if the aan condition was random, there wouldn't be one and there is only a small one in the atn-atp.


```{r after adj overall selection patterns, echo=FALSE, fig.height=4, fig.width=7, message=FALSE, warning=FALSE, paged.print=FALSE}

df_preadj_vs_adj %>%
  filter(prior == "none",
         (preadj_selection & timeStep_selec == "selectedItem_prior") | 
           (!preadj_selection & timeStep_selec == "selectedItem1")) %>% 
  ggplot(., aes(x=obj_in_display_diff, 
                            y=clicked, 
                            fill=obj_in_display_diff, 
                            alpha=timeStep_selec)) +
  facet_wrap(~condition_long, scales = "free_x", nrow=2) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               width = 0.8,
               position = position_dodge(width = 0.8)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               position = position_dodge(width = 0.8),
               size = .3,
               width = 0.3) +
  theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(3,0,3,0, "pt"))
        ) +
  scale_alpha_manual(values=c(0.5, 1)) +
  scale_fill_manual(values=c(target_color, comp_color, 
                               contrast_color, distractor_1_color, 
                               distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  xlab("Item function") +
  ylab("Proportion of clicks")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_fullwpreadj.png"), height=6, width=9)

```


### Main effects

```{r}
df_preadj_vs_adj %>% 
  filter(prior == "none",
         !preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  select(contrast_present, target_typ_bin, comp_typ_bin, clicked) %>% 
  gather(main_effect, value, contrast_present, target_typ_bin, comp_typ_bin) %>%
  mutate_at(vars(value), funs(case_when(
    .==T ~ "present",
    .==F ~ "absent",
    TRUE ~ .
  ))) %>% 
  ggplot(aes(x=main_effect, y=clicked, fill=value)) +
    stat_summary(fun.y = "mean", 
               geom = "bar",
               width = 0.7,
               position = position_dodge(width = 0.65)) +
    stat_summary(fun.data = "mean_cl_boot",
                 geom = "errorbar",
                 color = "black",
                 position = position_dodge(width = 0.65),
                 size = .3,
                 width = 0.3) +
    theme(legend.position = "top") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(3,0,3,0, "pt"))
        ) +
  # scale_alpha_manual(values=c(0.5, 1)) +
  # scale_fill_manual(values=c(target_color, comp_color, 
  #                              contrast_color, distractor_1_color, 
  #                              distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  # xlab("Item function") +
  ylab("Proportion of clicks")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_maineffects.png"), height=3, width=5)

```

### Main effects (more)

```{r}
df_adj %>% 
  filter(prior == "none",
         !preadj_selection,
         obj_in_display == "target") %>% 
  select(contrast_present, target_typ_bin, comp_typ_bin, clicked) %>% 
  ggplot(aes(x=contrast_present, y=clicked, color=comp_typ_bin)) +
    facet_wrap(~target_typ_bin) +
    stat_summary(fun = "mean", 
               geom = "point",
               width = 0.7) +
    stat_summary(fun.data = "mean_cl_boot",
                 geom = "errorbar",
                 size = .3,
                 width = 0.3) +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(3,0,3,0, "pt"))
        ) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  theme(legend.position = "top") +
  # xlab("Item function") +
  ylab("Proportion of clicks")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_maineffects2.png"), height=4, width=5)
```


#### By-item bias

We see a shift here compared to the prior. Now atypical items are more likely to be clicked on than typical ones.

```{r itemwise, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

df_byitemadj = df_adj %>%
  filter(!preadj_selection,
         prior == "none") %>% 
  filter(clickedType=="target" | clickedType=="comp") %>% 
  select(clickedType, target, comp, anon_worker_id) %>% 
  distinct() %>% 
  gather(obj_fct, item, target, comp) %>% 
  mutate(clicked = ifelse(clickedType == obj_fct, 1, 0)) %>% 
  left_join(typ_data, by=c("item"="col_type")) %>% 
  mutate(bin_typ=ifelse(typicality>50,"typical","atypical"))

ggplot(df_byitemadj, aes(x=reorder(item, clicked), y=clicked, fill=typicality)) +
  stat_summary(fun.y = "mean", 
               geom = "bar") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3) +
  theme(axis.text.x = element_text(angle=40, hjust=1)) +
  geom_hline(yintercept=1/2, linetype="dashed", color="grey") +
  xlab("Item") +
  ylab("Proportion of clicks") +
  labs(fill="Typicality")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_afteradj_byitembias.png"), height=4, width=6)
```

#### Switching behavior

Do people switch from their prior selection when they don't have to (due to informativity)? 
Mainly they don't, but there are differences in the patterns for different conditions.

Generally after observing the adjective, participants rather stay with the item they have clicked before. When participants switch there is a trend rather to switch from the competitor to the target than vice versa (conditions: ttp, atp, aap, atn, aan). In two conditions, the direction of switches seems to be arbitrary (conditions: tap, ttn). There is one condition, where there seems to be a tendency of more switches to the competitor after observing the adjective (condition: tan).

TODO: rewrite!

```{r switch, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

df_switch = df %>% 
  filter(preadj_selection,
         prior == "none",
         trial_type == "critical",
         !mult_selec,
         timeStep_selec == "selectedItem_prior" | timeStep_selec == "selectedItem1") %>% 
  select(clickedType, timeStep_selec, anon_worker_id, trial_number, target, comp, 
         condition, condition_long) %>% 
  distinct() %>% 
  spread(timeStep_selec, clickedType) %>% 
  filter((selectedItem_prior == "target" | selectedItem_prior == "comp") & 
           (selectedItem1 == "target" | selectedItem1 == "comp")) %>% 
  mutate(switch = ifelse(selectedItem_prior == selectedItem1, 0, 1)) %>% 
  mutate(switch_ct = factor(str_c(selectedItem_prior, selectedItem1, sep="_")))

ggplot(df_switch, aes(x=reorder(condition, switch), y=switch)) +
  stat_summary(fun.y = "mean", 
               geom = "bar",
               fill = "#db4900") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3) +
  theme(axis.text.x = element_text(angle=40, hjust=1)) +
  ylab("Proportion of switches\nafter observing adjective") +
  xlab("Condition")

df_switch %>% 
  mutate(used_combo = 1) %>% 
  spread(switch_ct, used_combo, fill=0) %>%
  gather(targcomp_combo, selected_combo, 
         target_target, target_comp, comp_comp, comp_target) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  mutate_at(vars(targcomp_combo), funs(factor(., levels=c("target_target", "comp_comp", "comp_target", "target_comp")))) %>% 
  mutate(adap_switch = ifelse(targcomp_combo=="target_comp" | 
                                targcomp_combo=="comp_target", T, F)) %>% 
  ggplot(., aes(x=targcomp_combo, y=selected_combo, fill=adap_switch)) +
    facet_wrap(~condition_long, nrow=2) +
    stat_summary(fun.y = "mean", 
                 geom = "bar") +
    stat_summary(fun.data = "mean_cl_boot",
                 geom = "errorbar",
                 color = "black",
                 size = .3,
                 width = 0.3) +
    theme(axis.text.x = element_text(angle=40, hjust=1)) +
    theme(legend.position = "none") +
    theme(strip.background = element_rect(color="black", 
                                          fill="white", 
                                          size=1.5,
                                          linetype="solid"),
          strip.text.x = element_text(margin = margin(3,0,3,0, "pt"))
          ) +
    scale_fill_manual(values = c("#009292", "#db4900")) +
    xlab("Click combination") +
    ylab("Number of occurrences")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_switchbycond.png"), height=6, width=9)

df_switch %>% 
  mutate(used_combo = 1) %>% 
  spread(switch_ct, used_combo, fill=0) %>%
  gather(targcomp_combo, selected_combo, 
         target_target, target_comp, comp_comp, comp_target) %>% 
  mutate_at(vars(condition), funs(factor(., levels=c("atp", "ttp", "aap", "tap", "atn", "ttn", "aan", "tan")))) %>%
  mutate_at(vars(targcomp_combo), funs(factor(., levels=c("target_target", "comp_comp", "comp_target", "target_comp")))) %>% 
  mutate(adap_switch = ifelse(targcomp_combo=="target_comp" | 
                                targcomp_combo=="comp_target", T, F)) %>% 
  ggplot(., aes(x=targcomp_combo, y=selected_combo, fill=adap_switch)) +
    # facet_wrap(~condition_long, nrow=2) +
    stat_summary(fun.y = "mean", 
                 geom = "bar") +
    stat_summary(fun.data = "mean_cl_boot",
                 geom = "errorbar",
                 color = "black",
                 size = .3,
                 width = 0.3) +
    # theme(axis.text.x = element_text(angle=40, hjust=1)) +
    theme(legend.position = "none") +
    theme(strip.background = element_rect(color="black", 
                                          fill="white", 
                                          size=1.5,
                                          linetype="solid"),
          strip.text.x = element_text(margin = margin(3,0,3,0, "pt"))
          ) +
    scale_fill_manual(values = c("#009292", "#db4900")) +
    xlab("Click combination") +
    ylab("Number of occurrences")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_switch.png"), height=3, width=4.5)

```

#### By-worker

```{r}
df_preadj_vs_adj %>% 
  filter(prior == "none",
         !preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  select(contrast_present, target_typ_bin, comp_typ_bin, clicked) %>% 
  mutate(typicality_boost = case_when(
    target_typ_bin == comp_typ_bin ~ "no_boost",
    target_typ_bin == "atypical" ~ "target_boost",
    TRUE ~ "comp_boost"
    )) %>% 
  gather(main_effect, value, contrast_present, typicality_boost) %>% 
  ggplot(aes(x=main_effect, y=clicked, fill=value)) +
    stat_summary(fun = "mean", 
               geom = "bar",
               width = 0.7,
               position = position_dodge(width = 0.65)) +
    stat_summary(fun.data = "mean_cl_boot",
                 geom = "errorbar",
                 color = "black",
                 position = position_dodge(width = 0.65),
                 size = .3,
                 width = 0.3) +
    # theme(legend.position = "none") +
  theme(strip.background = element_rect(color="black", 
                                        fill="white", 
                                        size=1.5,
                                        linetype="solid"),
        strip.text.x = element_text(margin = margin(3,0,3,0, "pt"))
        ) +
  # scale_alpha_manual(values=c(0.5, 1)) +
  # scale_fill_manual(values=c(target_color, comp_color, 
  #                              contrast_color, distractor_1_color, 
  #                              distractor_2_color, distractor_2_color)) +
  scale_x_discrete(labels=c("comp"="competitor")) +
  # theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  # xlab("Item function") +
  ylab("Proportion of clicks")


```
```{r}
df_by_worker_pref = df_preadj_vs_adj %>% 
  filter(prior == "none",
         !preadj_selection,
         timeStep_selec == "selectedItem1",
         obj_in_display == "target") %>% 
  mutate(contr = ifelse(contrast_present, "contr_present", "contr_absent")) %>% 
  select(contr, target_typ_bin, comp_typ_bin, clicked, anon_worker_id, betwsubj) %>% 
  mutate(typicality_boost = case_when(
    target_typ_bin == comp_typ_bin ~ "no_boost",
    target_typ_bin == "atypical" ~ "target_boost",
    TRUE ~ "comp_boost"
    )) %>% 
  # filter(typicality_boost != "no_boost") %>% 
  gather(main_effect, value, contr, typicality_boost) %>% 
  group_by(main_effect, value, anon_worker_id, betwsubj) %>% 
  summarize(mean_stuff = mean(clicked)) %>% 
  ungroup %>% 
  select(-main_effect) %>% 
  spread(value, mean_stuff) %>%
  mutate(contr_target_boost = contr_present - contr_absent) %>% 
  mutate(typicality_pref_change = ifelse(betwsubj == "typical", target_boost - no_boost,
                                          no_boost - comp_boost))
# ggplot(aes(x=contr_target_boost, y=typicality_pref_change, color=betwsubj)) +
ggplot(df_by_worker_pref, aes(x=contr_target_boost, y=typicality_pref_change)) +
  geom_point(alpha=0.9, position=position_jitter(width=0.05, height=0.05)) +
  geom_smooth(method="lm") +
  xlab("Contrast target boost") +
  ylab("Typicality preference change")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_byworker_contrTypPrefCorr.png"), height=3, width=4)

df_by_worker_pref %>% 
  mutate(t_bin = ifelse(typicality_pref_change > 0.05, "typ pref", 
                        ifelse(typicality_pref_change < -0.05, "rev typ pref", "no typ pref"))) %>% 
  mutate(c_bin = ifelse(contr_target_boost > 0.05, "contr pref", 
                        ifelse(contr_target_boost < -0.05, "rev contr pref", "no contr pref"))) %>%
  # mutate(c_bin = ifelse(contr_target_boost > 0, "contr pref", "no contr pref")) %>% 
  gather(pref_cat, pref_value, t_bin, c_bin) %>% 
  mutate_at(vars(pref_value), funs(fct_relevel(., "typ pref", "no typ pref", "rev typ pref", "contr pref", "no contr pref"))) %>% 
  mutate_at(vars(pref_cat), funs(fct_relevel(., "t_bin"))) %>% 
  ggplot(., aes(x=pref_cat, fill = pref_value)) +
    geom_bar(stat="count",
             position=position_dodge(0.8))

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_byworker_pref.png"), height=3, width=4.5)

df_by_worker_pref %>% 
  # mutate(t_bin = ifelse(typicality_pref_change > 0.05, "typ pref", 
  #                       ifelse(typicality_pref_change < -0.05, "rev typ pref", "no typ pref"))) %>% 
  # mutate(c_bin = ifelse(contr_target_boost > 0.05, "contr pref", 
  #                       ifelse(contr_target_boost < -0.05, "rev contr pref", "no contr pref"))) %>% 
  mutate(t_bin = ifelse(typicality_pref_change > 0, "typ: target boost", "typ: no target boost")) %>%
  mutate(c_bin = ifelse(contr_target_boost > 0, "contr: target boost", "contr: no target boost")) %>%
  mutate(pref_comb = str_c(c_bin,t_bin, sep="\n")) %>% 
  ggplot(., aes(x=pref_comb)) +
    geom_bar(stat="count")
    # theme(axis.text.x = element_text(angle=30, hjust=1))

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_byworker_summary.png"), height=4, width=6)
```

## After noun selections -- all information available

We will only look at the critical trials.

```{r prepare after adj df, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

df_noun = df %>%
  filter(timeStep_selec == "selectedItem2",
         trial_type == "critical")

df_adj_vs_noun = df %>% 
  filter(timeStep_selec == "selectedItem1" | timeStep_selec == "selectedItem2",
         trial_type == "critical")
```

#### Multiple selection/Error pattern

Is there a pattern to where the most errors/multiple selections occur? I don't see a pattern here.

```{r after noun error and mult selections, echo=FALSE, warning=FALSE, paged.print=FALSE}

df_multselec = df_adj_vs_noun %>% 
  filter(clicked==1,
         prior == "none") %>% 
  mutate(adj_error = ifelse(timeStep_selec == "selectedItem1" & 
                    (clickedType == "contrast/distractor" | clickedType == "distractor"), 
                    T, F)) %>% 
  mutate(noun_error = ifelse(timeStep_selec == "selectedItem2" & clickedType != "target", 
                             T, F)) %>% 
  mutate(overall_error = ifelse(adj_error | noun_error, T, F))

# nrow(df_multselec)
# table(df_multselec$condition)

df_multselec %>% 
  filter(timeStep_selec == "selectedItem2",
         mult_selec | noun_error) %>% 
  ggplot(., aes(x=condition)) +
    geom_bar(stat = "count") +
  ggtitle("Multiple selections and errors after noun")

df_multselec %>% 
  filter(adj_error) %>% 
  ggplot(., aes(x=condition)) +
    geom_bar(stat = "count") +
  ggtitle("Errors after adjective")

```

## Generally

#### Is there an overall target position bias? (We need this to address the position bias question in the prior, if existent. But for this we also need to consider the fillers and not just the critical trials.)


```{r general target position bias, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

df_targetpos = df_preadj_wfillers %>% 
  filter(clicked==1,
         prior=="none") %>% 
  gather(position, obj_in_pos, pos1, pos2, pos3, pos4) %>% 
  mutate(target_pos = ifelse(obj_in_pos == "target", 1, 0)) %>% 
  mutate(comp_pos = ifelse(obj_in_pos == "comp", 1, 0)) %>% 
  mutate(contr_pos = ifelse(obj_in_pos == "contrast", 1, 0)) %>% 
  mutate(distr_pos = ifelse(obj_in_pos == "distractor", 1, 0))

ggplot(df_targetpos, aes(x=position, y=target_pos, fill=position)) +
  stat_summary(fun.y = "mean", 
               geom = "bar") +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "errorbar",
               color = "black",
               size = .3,
               width = 0.3) +
  theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  theme(legend.position = "none")

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_targetposbias.png"), height=3, width=4.5)

```

#### By-item analysis -- which items were most likely to be targets?

Because there were a lot of unmodified expressions in the fillers that could only refer to typical objects, typical objects were in general more likely to be the target. This is not true for the critical trials.

```{r by-item targets, include=FALSE}

df_byitemtargets = df_preadj_wfillers %>%
  filter(prior=="none") %>% 
  select(refObject, target, comp, contrast, distractor, anon_worker_id, trial_number) %>% 
  distinct() %>% 
  gather(obj_fct, item, target, comp, contrast, distractor) %>% 
  filter(refObject==obj_fct) %>% 
  left_join(typ_data, by=c("item"="col_type"))
  
ggplot(df_byitemtargets, aes(x=reorder(item, typicality), fill=typicality)) +
  geom_bar(stat="count") +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))

# ggsave(here("analyses","full_analysis","graphs","comprehension_noprior_targetbytypicality.png"), height=3.5, width=5)

```




## Stats prediction

```{r}
# new_data = df_m_noprior_nopreadjsel %>% 
#   select(target, comp, anon_worker_id, c_contrast, c_target_typ_bin, c_comp_typ_bin, click_to_target,condition) %>% 
#   rowid_to_column("ID")
# 
# predictions = predict(model_noprior_nopreadjsel, 
#                       newdata = new_data, 
#                       re_formula = NA)
# 
# bl = predictions %>% 
#   as_tibble() %>% 
#   rowid_to_column("ID")
# 
# plot_preds = new_data %>% 
#   left_join(bl) %>% 
#   select(condition,click_to_target,Estimate) %>% 
#   rename(empirical = "click_to_target",
#          prediction = "Estimate") %>% 
#   gather(data_cat, value, empirical, prediction) 
#   # mutate_at(vars(value), funs(ifelse(.<=0.5, 0, 1)))
# 
# ggplot(plot_preds, aes(x=condition, y=value, fill=data_cat)) +
#   # geom_point() +
#   stat_summary(fun=mean,
#                geom="bar",
#                position=position_dodge(0.8)) +
#   stat_summary(fun.data="mean_cl_boot",
#                geom="errorbar",
#                size=0.3,
#                width=0.3,
#                position=position_dodge(width=0.8))
```

# TODO: File creation

## Shiny files

```{r shiny}
df %>% 
  filter(timeStep_selec == "selectedItem_prior") %>% 
  select(condition, obj_in_display_diff, clicked) %>% 
  write_csv(., "emp_prevsel_noprior.csv", col_names = TRUE)
```

## RSA files

```{r rsa}
write_csv(df_prior_vs_adj, here("models","02_prodInfRSA","data","emp_comprehension_data.csv"))
```